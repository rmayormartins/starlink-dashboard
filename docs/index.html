<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>STARLINK TACTICAL OPERATIONS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Satellite.js -->
  <script src="https://unpkg.com/satellite.js@5.0.0/dist/satellite.min.js"></script>
  
  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #000000;
      color: #999999;
      font-size: 12px;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      height: 50px;
      background: #1a1a1a;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      background: #ff0000;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
      50% { opacity: 0.3; box-shadow: 0 0 0 10px rgba(255,0,0,0); }
    }
    
    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    
    .header-stats {
      display: flex;
      gap: 30px;
      font-family: 'Share Tech Mono', monospace;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-size: 20px;
      color: #ffffff;
      font-weight: 500;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666666;
      text-transform: uppercase;
    }
    
    #meta {
      font-size: 11px;
      color: #00ff00;
      margin-left: 20px;
    }
    
    /* View Tabs */
    .view-tabs {
      height: 40px;
      background: #111111;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 10px;
    }
    
    .tab-btn {
      padding: 8px 20px;
      background: #1a1a1a;
      border: 1px solid #333333;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      background: #222222;
      color: #ffffff;
    }
    
    .tab-btn.active {
      background: #990000;
      border-color: #ff0000;
      color: #ffffff;
    }
    
    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background: #0a0a0a;
    }
    
    /* Left Panel */
    .left-panel {
      width: 320px;
      background: #111111;
      border-right: 1px solid #333333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .left-panel-scrollable {
      flex: 1;
      overflow-y: auto;
    }
    
    .panel-section {
      border-bottom: 1px solid #222222;
    }
    
    .section-title {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
    }
    
    .section-content {
      padding: 15px;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    .control-label {
      display: block;
      margin-bottom: 5px;
      color: #666666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .control-input {
      width: 100%;
      padding: 6px 10px;
      background: #000000;
      border: 1px solid #333333;
      color: #ffffff;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #ff0000;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #ff0000;
    }
    
    .checkbox-group label {
      color: #999999;
      text-transform: uppercase;
      font-size: 11px;
    }
    
    .btn {
      width: 100%;
      padding: 8px;
      background: #990000;
      border: 1px solid #ff0000;
      color: #ffffff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    
    .btn:hover {
      background: #ff0000;
      box-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    
    .btn.active {
      background: #00ff00;
      border-color: #00ff00;
      color: #000000;
    }
    
    /* Terminal */
    .terminal {
      height: 120px;
      background: #000000;
      border: 1px solid #222222;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
    }
    
    .terminal-line {
      margin: 2px 0;
      color: #999999;
    }
    
    .terminal-line .time { color: #666666; }
    .terminal-line .type { color: #ff0000; }
    .terminal-line .message { color: #ffffff; }
    
    /* View Container */
    .view-container {
      flex: 1;
      position: relative;
      background: #000000;
    }
    
    .view-content {
      width: 100%;
      height: 100%;
      display: none;
    }
    
    .view-content.active {
      display: block;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    #globe {
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
    }
    
    /* Map Overlay */
    .map-overlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 15px;
      min-width: 200px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .overlay-title {
      color: #ff0000;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .data-row {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
    }
    
    .data-label {
      color: #666666;
    }
    
    .data-value {
      color: #ffffff;
    }
    
    .data-value.good { color: #00ff00; }
    .data-value.warning { color: #ffaa00; }
    .data-value.critical { color: #ff0000; }
    
    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.95);
      border: 1px solid #333333;
      padding: 10px;
      font-size: 11px;
      z-index: 10000;
      pointer-events: auto;
    }
    
    .legend-title {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border: 1px solid #333333;
    }
    
    /* Right Panel - RF Analysis */
    .right-panel {
      width: 400px;
      background: #111111;
      border-left: 1px solid #333333;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    
    .info-card {
      border-bottom: 1px solid #222222;
      flex-shrink: 0;
    }
    
    .card-header {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #ffffff;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .card-content {
      padding: 15px;
    }
    
    .sat-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    #orbital-info.sat-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .sat-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .sat-info-label {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
    }
    
    .sat-info-value {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .terminal-text {
      font-family: 'Share Tech Mono', monospace;
      white-space: pre;
      line-height: 1.3;
      color: #00ff00;
      font-size: 11px;
    }
    
    /* Leaflet Popup Dark Theme */
    .leaflet-popup-content-wrapper {
      background: #000000 !important;
      border: 1px solid #00ff00 !important;
      border-radius: 0 !important;
      box-shadow: 0 0 10px rgba(0,255,0,0.3) !important;
    }
    
    .leaflet-popup-content {
      color: #ffffff !important;
      font-family: 'Share Tech Mono', monospace !important;
      font-size: 11px !important;
      margin: 10px !important;
      line-height: 1.4 !important;
    }
    
    .leaflet-popup-tip {
      background: #000000 !important;
      border: 1px solid #00ff00 !important;
      box-shadow: none !important;
    }
    
    .leaflet-popup-close-button {
      color: #00ff00 !important;
      font-size: 16px !important;
      font-weight: bold !important;
      text-shadow: 0 0 3px #00ff00 !important;
    }
    
    .leaflet-popup-close-button:hover {
      color: #ffffff !important;
      background: rgba(0,255,0,0.2) !important;
    }
    
    .terminal-popup {
      white-space: pre;
      line-height: 1.4;
      color: #ffffff;
    }
    
    /* Highlighted selected satellite */
    .leaflet-interactive.selected-satellite {
      filter: drop-shadow(0 0 8px #ffffff) !important;
      z-index: 1000 !important;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #000000; }
    ::-webkit-scrollbar-thumb { background: #333333; }
    ::-webkit-scrollbar-thumb:hover { background: #666666; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <div class="status-indicator"></div>
      <h1>Starlink Tactical Operations</h1>
      <div id="meta">[INITIALIZING...]</div>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-visible">0</div>
        <div class="stat-label">Visible</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tracked">0</div>
        <div class="stat-label">Tracked</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total</div>
      </div>
    </div>
  </div>

  <!-- View Tabs -->
  <div class="view-tabs">
    <button class="tab-btn active" onclick="switchView('map')">2D MERCATOR</button>
    <button class="tab-btn" onclick="switchView('globe')">3D GLOBE</button>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Panel - Controls & Log -->
    <div class="left-panel">
      <div class="left-panel-scrollable">
        <div class="panel-section">
          <div class="section-title">Target Operation</div>
          <div class="section-content">
            <div class="control-group">
              <label class="control-label">Latitude</label>
              <input type="number" id="lat" class="control-input" value="-27.588" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Longitude</label>
              <input type="number" id="lon" class="control-input" value="-48.613" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Min Elevation (°)</label>
              <input type="number" id="elevMin" class="control-input" value="25" min="0" max="90" step="5">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showFootprints" checked>
              <label for="showFootprints">Show Footprints</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="footprintSelectedOnly">
              <label for="footprintSelectedOnly">Selected Only</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showTrajectory">
              <label for="showTrajectory">Show Trajectory</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="trajectorySelectedOnly">
              <label for="trajectorySelectedOnly">Selected Only</label>
            </div>
            <button class="btn" id="btnApply">EXECUTE</button>
            <button class="btn" id="btnPause">PAUSE ORBITS</button>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">Orbit Filters</div>
          <div class="section-content">
            <div class="checkbox-group">
              <input type="checkbox" id="filterLEO" checked>
              <label for="filterLEO">LEO (<2000km)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="filterMEO" checked>
              <label for="filterMEO">MEO (2000-35786km)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="filterHEO" checked>
              <label for="filterHEO">HEO (>35786km)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="filterVisible" checked>
              <label for="filterVisible">All Visible</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="filterAll" checked>
              <label for="filterAll">All Possible</label>
            </div>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">3D Controls</div>
          <div class="section-content">
            <button class="btn" onclick="resetGlobeView()">RESET VIEW</button>
            <button class="btn" onclick="toggleRotation()">AUTO ROTATE</button>
            <div style="margin-top: 10px;">
              <label class="control-label">Orbit Speed</label>
              <input type="range" id="orbitSpeed" min="1" max="100" value="10" style="width: 100%;">
            </div>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">Mission Status</div>
          <div class="section-content">
            <div id="visibleInfo" style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
              <div class="data-row">
                <span class="data-label">STATUS:</span>
                <span class="data-value">INITIALIZING</span>
              </div>
              <div class="data-row">
                <span class="data-label">RENDER:</span>
                <span class="data-value">0 ms</span>
              </div>
              <div class="data-row">
                <span class="data-label">LINK:</span>
                <span class="data-value good">OPERATIONAL</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- System Log -->
        <div class="panel-section">
          <div class="section-title">System Log</div>
          <div class="section-content" style="padding: 0;">
            <div class="terminal" id="terminalOutput"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- View Container -->
    <div class="view-container">
      <!-- 2D Map View -->
      <div id="map-view" class="view-content active">
        <div id="map"></div>
        
        <!-- Map Overlay -->
        <div class="map-overlay">
          <div class="overlay-title">Target Details</div>
          <div id="targetInfo">
            <div class="data-row">
              <span class="data-label">SAT ID:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">ELEV:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">AZIM:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">RANGE:</span>
              <span class="data-value">---</span>
            </div>
          </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
          <div class="legend-title">Satellite Status</div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            <span style="color: #999999;">HIGH ALT (>600km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffff00;"></div>
            <span style="color: #999999;">MED ALT (550-600km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            <span style="color: #999999;">NORM ALT (500-550km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #0000ff;"></div>
            <span style="color: #999999;">LOW ALT (<500km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffffff;"></div>
            <span style="color: #999999;">SELECTED</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #006600;"></div>
            <span style="color: #999999;">NOT VISIBLE</span>
          </div>
          <div style="margin-top: 8px; font-size: 9px; color: #666666;">
            LEO: <2000km | MEO: 2000-35786km | HEO: >35786km<br>
            ─── Trajectory | ┅┅┅ Future Path
          </div>
        </div>
      </div>
      
      <!-- 3D Globe View -->
      <div id="globe-view" class="view-content">
        <div id="globe"></div>
        
        <!-- Globe Info -->
        <div class="map-overlay">
          <div class="overlay-title">Globe Statistics</div>
          <div id="globeInfo">
            <div class="data-row">
              <span class="data-label">SATELLITES:</span>
              <span class="data-value" id="globe-sats">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">FPS:</span>
              <span class="data-value" id="globe-fps">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">ROTATION:</span>
              <span class="data-value" id="globe-rotation">OFF</span>
            </div>
            <div class="data-row">
              <span class="data-label">ORBITS:</span>
              <span class="data-value" id="globe-orbits">ACTIVE</span>
            </div>
            <div class="data-row">
              <span class="data-label">TIME:</span>
              <span class="data-value" id="globe-time">00:00:00</span>
            </div>
          </div>
        </div>
        
        <!-- 3D Legend -->
        <div class="legend">
          <div class="legend-title">Altitude Color Code</div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            <span style="color: #999999;">HIGH (>600km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffff00;"></div>
            <span style="color: #999999;">MEDIUM (550-600km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            <span style="color: #999999;">NORMAL (500-550km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #0000ff;"></div>
            <span style="color: #999999;">LOW (<500km)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Satellite Data -->
    <div class="right-panel">
      <!-- Selected Satellite Data -->
      <div class="info-card">
        <div class="card-header">Satellite Data</div>
        <div class="card-content">
          <div id="sat-info" class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">NORAD</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">NAME</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ALTITUDE</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">VELOCITY</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ELEVATION</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">AZIMUTH</span>
              <span class="sat-info-value">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- RF Link Analysis -->
      <div class="info-card">
        <div class="card-header">RF Link Analysis</div>
        <div class="card-content">
          <div style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
            <div class="data-row">
              <span class="data-label">FREQ DL:</span>
              <span class="data-value">10.7-12.7 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">FREQ UL:</span>
              <span class="data-value">14.0-14.5 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">RX POWER:</span>
              <span class="data-value" id="rf-power">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">FSPL:</span>
              <span class="data-value" id="rf-fspl">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">LINK STATUS:</span>
              <span class="data-value" id="rf-status">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Orbital Elements -->
      <div class="info-card">
        <div class="card-header">Orbital Elements</div>
        <div class="card-content">
          <div id="orbital-info" class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">STATUS</span>
              <span class="sat-info-value">NO SATELLITE</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ACTION</span>
              <span class="sat-info-value">SELECT SAT</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ==================== CONFIGURAÇÃO GLOBAL ====================
    const DATA_URL = "data/starlink_tle.json";
    const META_URL = "data/meta.json";
    const REFRESH_MS = 3000;
    
    // TLEs de fallback válidos (Gen2 Starlink)
    const FALLBACK_TLEs = [
      {
        "name": "STARLINK-30440",
        "noradId": "57812",
        "line1": "1 57812U 23126W   24219.25000000  .00000832  00000-0  73125-4 0  9995",
        "line2": "2 57812  43.0010 315.8972 0.0003456 268.7432  91.3456 15.02531234 52348"
      },
      {
        "name": "STARLINK-30441",
        "noradId": "57813",
        "line1": "1 57813U 23126X   24219.26000000  .00000945  00000-0  81234-4 0  9993",
        "line2": "2 57813  43.0012 316.1234 0.0002987 269.1234  90.8765 15.02531456 52349"
      },
      {
        "name": "STARLINK-30442",
        "noradId": "57814",
        "line1": "1 57814U 23126Y   24219.27000000  .00000756  00000-0  69876-4 0  9991",
        "line2": "2 57814  43.0008 315.7654 0.0003789 268.9876  91.0123 15.02531678 52350"
      },
      {
        "name": "STARLINK-30443",
        "noradId": "57815",
        "line1": "1 57815U 23126Z   24219.28000000  .00000634  00000-0  58901-4 0  9990",
        "line2": "2 57815  43.0015 316.2345 0.0002456 269.3456  90.6543 15.02531890 52351"
      },
      {
        "name": "STARLINK-30444",
        "noradId": "57816",
        "line1": "1 57816U 23126AA  24219.29000000  .00000723  00000-0  65432-4 0  9992",
        "line2": "2 57816  43.0009 315.9876 0.0003123 268.8765  91.1234 15.02532102 52352"
      },
      {
        "name": "STARLINK-31001",
        "noradId": "58001",
        "line1": "1 58001U 23127A   24219.30000000  .00000512  00000-0  52341-4 0  9994",
        "line2": "2 58001  43.0020 325.1234 0.0002134 267.5678 92.4321 15.02530987 52360"
      },
      {
        "name": "STARLINK-31002",
        "noradId": "58002",
        "line1": "1 58002U 23127B   24219.31000000  .00000623  00000-0  61234-4 0  9996",
        "line2": "2 58002  43.0018 324.9876 0.0002567 268.1234 91.8765 15.02531123 52361"
      },
      {
        "name": "STARLINK-31003",
        "noradId": "58003",
        "line1": "1 58003U 23127C   24219.32000000  .00000734  00000-0  72567-4 0  9998",
        "line2": "2 58003  43.0016 324.7654 0.0002890 268.6789 91.3210 15.02531456 52362"
      }
    ];
    
    // ==================== ESTADO GLOBAL ====================
    let currentView = 'map';
    let globe3D = null;
    let scene3D, camera3D, renderer3D;
    let earthMesh, satellites3D = [];
    let autoRotate = false;
    let orbitsPaused = false;
    let animationId = null;
    
    let tleList = [];
    let satRecs = [];
    let map, layerGroup, footprintGroup, trajectoryGroup;
    let obs = { lat: -27.588, lon: -48.613, elevMin: 25 };
    let selectedSatellite = null;
    let isDrawing = false;
    let selectedPopup = null; // Para manter o popup aberto
    
    let config = {
      showFootprints: true,
      footprintSelectedOnly: false,
      showTrajectory: false,
      trajectorySelectedOnly: false,
      maxFootprints: 5,
      filters: {
        LEO: true,
        MEO: true,
        HEO: true,
        visible: true,
        all: true
      }
    };
    
    // ==================== INICIALIZAÇÃO ====================
    
    async function init() {
      updateTerminalLog("SYSTEM", "Initializing Starlink Tactical Operations...");
      
      console.log(`%c
╔═══════════════════════════════════════════╗
║     STARLINK TACTICAL OPERATIONS         ║
║         CENTRO OPERACIONAL TÁTICO        ║
╚═══════════════════════════════════════════╝
      `, "color: #00ff00; font-family: monospace");
      
      try {
        await loadSatelliteData();
        init2DMap();
        setupControls();
        setObserverLocation();
        startSimulation();
        updateTerminalLog("SYSTEM", "TACTICAL OPERATIONS CENTER ONLINE");
      } catch (e) {
        updateTerminalLog("ERROR", `Critical failure: ${e.message}`);
      }
    }
    
    async function loadSatelliteData() {
      updateTerminalLog("DATA", "Loading satellite orbital elements...");
      
      try {
        // Tentar carregar metadados primeiro
        try {
          const metaResponse = await fetch(META_URL);
          if (metaResponse.ok) {
            const meta = await metaResponse.json();
            document.getElementById("meta").innerHTML = 
              `[SATS: ${meta.count}] [SRC: ${meta.source}] [UPD: ${new Date(meta.updatedAt).toLocaleString('pt-BR')}]`;
            updateTerminalLog("DATA", `Metadata loaded: ${meta.count} satellites`);
          }
        } catch (e) {
          updateTerminalLog("WARNING", "Metadata not available");
        }
        
        // Tentar carregar dados externos
        const dataResponse = await fetch(DATA_URL);
        if (dataResponse.ok) {
          tleList = await dataResponse.json();
          updateTerminalLog("DATA", `${tleList.length} TLEs loaded from external source`);
        } else {
          throw new Error("External data not available");
        }
        
      } catch (e) {
        updateTerminalLog("WARNING", `External data unavailable: ${e.message}`);
        updateTerminalLog("DATA", "Switching to tactical fallback constellation...");
        
        tleList = FALLBACK_TLEs;
        document.getElementById("meta").innerHTML = `[FALLBACK MODE] [SATS: ${tleList.length}] [STATUS: TACTICAL]`;
        updateTerminalLog("DATA", `${tleList.length} tactical satellites loaded from fallback`);
      }
      
      // Processar TLEs
      updateTerminalLog("CALC", "Processing orbital elements with SGP4...");
      parseTLEData();
    }
    
    function parseTLEData() {
      satRecs = [];
      let validCount = 0;
      
      tleList.forEach((tle, index) => {
        try {
          if (!tle.line1 || !tle.line2) {
            updateTerminalLog("TLE", `Invalid TLE format for ${tle.name || index}`);
            satRecs.push(null);
            return;
          }
          
          const satrec = satellite.twoline2satrec(tle.line1, tle.line2);
          
          if (satrec.error) {
            updateTerminalLog("TLE", `SGP4 error for ${tle.name}: ${satrec.error}`);
            satRecs.push(null);
            return;
          }
          
          // Test propagation
          const testTime = new Date();
          const testResult = satellite.propagate(satrec, testTime);
          
          if (!testResult.position || isNaN(testResult.position.x)) {
            updateTerminalLog("TLE", `Propagation failed for ${tle.name}`);
            satRecs.push(null);
            return;
          }
          
          satRecs.push(satrec);
          validCount++;
          
        } catch (e) {
          updateTerminalLog("TLE", `Error processing ${tle.name}: ${e.message}`);
          satRecs.push(null);
        }
      });
      
      updateTerminalLog("CALC", `${validCount}/${tleList.length} satellites ready for tracking`);
      updateStats(0, 0, validCount);
    }
    
    function init2DMap() {
      updateTerminalLog("MAP", "Initializing tactical map system...");
      
      map = L.map("map", { 
        worldCopyJump: true,
        preferCanvas: true,
        renderer: L.canvas(),
        zoomControl: false
      }).setView([obs.lat, obs.lon], 3);
      
      // Dark tactical map
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© TACTICAL MAP',
        subdomains: 'abcd',
        maxZoom: 10,
        minZoom: 2
      }).addTo(map);
      
      // Layer groups
      layerGroup = L.layerGroup().addTo(map);
      footprintGroup = L.layerGroup().addTo(map);
      trajectoryGroup = L.layerGroup().addTo(map);
      
      // Observer location marker - TRIÂNGULO BRANCO TÁTICO
      const observerIcon = L.divIcon({
        html: `<div style="
          width: 0;
          height: 0;
          border-left: 8px solid transparent;
          border-right: 8px solid transparent;
          border-bottom: 14px solid #ffffff;
          filter: drop-shadow(0 0 6px #ffffff);
          transform: rotate(0deg);
        "></div>`,
        iconSize: [16, 16],
        iconAnchor: [8, 14],
        className: 'tactical-base-marker'
      });
      
      L.marker([obs.lat, obs.lon], { icon: observerIcon }).addTo(map)
        .bindPopup('<strong>TACTICAL BASE</strong><br>Campinas, SC<br>Status: OPERATIONAL');
      
      updateTerminalLog("MAP", "Tactical map system online");
    }
    
    function setupControls() {
      document.getElementById("btnApply").addEventListener('click', () => {
        setObserverLocation();
        updateSatellites();
        updateTerminalLog("CMD", "Tactical parameters updated");
      });
      
      // Pause button
      document.getElementById("btnPause").addEventListener('click', () => {
        orbitsPaused = !orbitsPaused;
        const btn = document.getElementById("btnPause");
        btn.textContent = orbitsPaused ? "RESUME ORBITS" : "PAUSE ORBITS";
        btn.classList.toggle('active', orbitsPaused);
        updateTerminalLog("CMD", `Orbital motion ${orbitsPaused ? 'PAUSED' : 'RESUMED'}`);
        
        // Update 3D globe display
        const globeOrbits = document.getElementById("globe-orbits");
        if (globeOrbits) {
          globeOrbits.textContent = orbitsPaused ? "PAUSED" : "ACTIVE";
        }
      });
      
      // Checkbox controls
      document.getElementById("showFootprints").addEventListener('change', (e) => {
        config.showFootprints = e.target.checked;
        updateTerminalLog("CONFIG", `Footprints ${config.showFootprints ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("footprintSelectedOnly").addEventListener('change', (e) => {
        config.footprintSelectedOnly = e.target.checked;
        updateTerminalLog("CONFIG", `Footprint selected only ${config.footprintSelectedOnly ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("showTrajectory").addEventListener('change', (e) => {
        config.showTrajectory = e.target.checked;
        updateTerminalLog("CONFIG", `Trajectory ${config.showTrajectory ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("trajectorySelectedOnly").addEventListener('change', (e) => {
        config.trajectorySelectedOnly = e.target.checked;
        updateTerminalLog("CONFIG", `Trajectory selected only ${config.trajectorySelectedOnly ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      // Orbit filter controls
      document.getElementById("filterLEO").addEventListener('change', (e) => {
        config.filters.LEO = e.target.checked;
        updateTerminalLog("FILTER", `LEO filter ${config.filters.LEO ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("filterMEO").addEventListener('change', (e) => {
        config.filters.MEO = e.target.checked;
        updateTerminalLog("FILTER", `MEO filter ${config.filters.MEO ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("filterHEO").addEventListener('change', (e) => {
        config.filters.HEO = e.target.checked;
        updateTerminalLog("FILTER", `HEO filter ${config.filters.HEO ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("filterVisible").addEventListener('change', (e) => {
        config.filters.visible = e.target.checked;
        updateTerminalLog("FILTER", `Visible filter ${config.filters.visible ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("filterAll").addEventListener('change', (e) => {
        config.filters.all = e.target.checked;
        updateTerminalLog("FILTER", `All filter ${config.filters.all ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
    }
    
    function setObserverLocation() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const elevMin = parseFloat(document.getElementById('elevMin').value);
      
      if (isNaN(lat) || isNaN(lon) || isNaN(elevMin)) {
        updateTerminalLog('OBS', 'Invalid tactical coordinates');
        return;
      }
      
      obs = {
        lat: lat,
        lon: lon,
        elevMin: elevMin,
        height: 0
      };
      
      if (map) {
        map.setView([lat, lon], map.getZoom());
      }
      
      updateTerminalLog('OBS', `Tactical position: ${lat.toFixed(3)}°N, ${lon.toFixed(3)}°W, Elev>${elevMin}°`);
    }
    
    function startSimulation() {
      updateTerminalLog('SIM', 'Starting real-time orbital tracking...');
      
      // Main update loop
      setInterval(() => {
        if (!isDrawing && !orbitsPaused) {
          updateSatellites();
        }
      }, REFRESH_MS);
      
      // Initial update
      updateSatellites();
    }
    
    // ==================== GLOBO 3D CORRIGIDO ====================
    
    function init3DGlobe() {
      const container = document.getElementById('globe');
      if (!container) {
        updateTerminalLog('3D', 'ERROR: Globe container not found');
        return;
      }
      
      updateTerminalLog('3D', 'Initializing tactical 3D display...');
      
      // Clear previous content
      container.innerHTML = '';
      
      // Scene setup - TÁTICO PRETO
      scene3D = new THREE.Scene();
      scene3D.background = new THREE.Color(0x000000); // Preto tático
      
      // Camera setup
      const aspect = container.clientWidth / container.clientHeight;
      camera3D = new THREE.PerspectiveCamera(50, aspect, 1, 200000);
      camera3D.position.set(20000, 15000, 20000);
      camera3D.lookAt(0, 0, 0);
      
      // Renderer setup
      renderer3D = new THREE.WebGLRenderer({ 
        antialias: true,
        alpha: false
      });
      renderer3D.setSize(container.clientWidth, container.clientHeight);
      renderer3D.setClearColor(0x000000, 1); // Fundo preto tático
      renderer3D.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      container.appendChild(renderer3D.domElement);
      
      updateTerminalLog('3D', `Renderer created: ${container.clientWidth}x${container.clientHeight}`);
      
      // Lighting - TÁTICO
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6); // Luz ambiente reduzida
      scene3D.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8); // Luz direcionada reduzida
      directionalLight.position.set(30000, 20000, 30000);
      scene3D.add(directionalLight);
      
      updateTerminalLog('3D', 'Tactical lighting configured');
      
      createEarth();
      setupGlobeControls();
      
      updateTerminalLog('3D', 'Earth and controls created');
      
      // Wait for satellites then create them
      setTimeout(() => {
        if (satRecs && satRecs.length > 0) {
          create3DSatellites();
          globe3D = true;
          animate3D();
          updateTerminalLog('3D', 'Animation started');
        } else {
          updateTerminalLog('3D', 'No satellites available, retrying...');
          setTimeout(() => init3DGlobe(), 2000);
        }
      }, 500);
    }
    
    function createEarth() {
      // Terra TÁTICA PRETA
      const earthGeometry = new THREE.SphereGeometry(6371, 128, 64);
      const earthMaterial = new THREE.MeshPhongMaterial({
        color: 0x111111, // Cinza escuro tático
        emissive: 0x000000, // Sem emissão
        emissiveIntensity: 0,
        specular: 0x222222, // Reflexo muito sutil
        shininess: 5,
        transparent: false,
        opacity: 1.0
      });
      
      earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
      scene3D.add(earthMesh);
      
      // Wireframe tático verde
      const wireframeGeometry = new THREE.SphereGeometry(6372, 64, 32);
      const wireframeMaterial = new THREE.MeshBasicMaterial({
        color: 0x004400, // Verde escuro tático
        wireframe: true,
        transparent: true,
        opacity: 0.4
      });
      const wireframeMesh = new THREE.Mesh(wireframeGeometry, wireframeMaterial);
      scene3D.add(wireframeMesh);
      
      // Observer location - TRIÂNGULO BRANCO TÁTICO
      const markerGeometry = new THREE.ConeGeometry(200, 400, 3); // Cone triangular
      const markerMaterial = new THREE.MeshBasicMaterial({
        color: 0xffffff, // Branco brilhante
        emissive: 0xffffff,
        emissiveIntensity: 0.5
      });
      const observerMarker = new THREE.Mesh(markerGeometry, markerMaterial);
      
      const lat = obs.lat * Math.PI / 180;
      const lon = obs.lon * Math.PI / 180;
      const radius = 6371 + 100;
      
      observerMarker.position.x = radius * Math.cos(lat) * Math.cos(lon);
      observerMarker.position.y = radius * Math.sin(lat);
      observerMarker.position.z = radius * Math.cos(lat) * Math.sin(lon);
      
      // Orientar o triângulo para cima
      observerMarker.lookAt(
        observerMarker.position.x * 2,
        observerMarker.position.y * 2,
        observerMarker.position.z * 2
      );
      
      scene3D.add(observerMarker);
      
      updateTerminalLog('3D', 'Tactical Earth and base marker created');
    }
    
    function create3DSatellites() {
      updateTerminalLog('3D', `Creating 3D satellites - TLE count: ${tleList.length}, SGP4 count: ${satRecs.length}`);
      
      const validSats = satRecs.filter(r => r !== null);
      if (validSats.length === 0) {
        updateTerminalLog('3D', 'No valid satellites for 3D display, retrying...');
        setTimeout(create3DSatellites, 2000);
        return;
      }
      
      updateTerminalLog('3D', `Found ${validSats.length} valid satellites, creating 3D objects...`);
      
      // Clear existing satellites
      satellites3D.forEach(sat => {
        if (sat.parent) {
          sat.parent.remove(sat);
        }
        if (sat.material) sat.material.dispose();
        if (sat.geometry) sat.geometry.dispose();
      });
      satellites3D = [];
      
      // Create bright satellites
      const satGeometry = new THREE.SphereGeometry(300, 16, 16);
      let createdCount = 0;
      let positionedCount = 0;
      
      updateTerminalLog('3D', 'Geometry created, processing satellites...');
      
      satRecs.forEach((satrec, index) => {
        if (!satrec) return;
        
        try {
          // Create bright material
          const material = new THREE.MeshBasicMaterial({
            color: 0x00ff00,
            transparent: false
          });
          
          const satelliteMesh = new THREE.Mesh(satGeometry, material);
          satelliteMesh.userData = { 
            index: index,
            tle: tleList[index],
            rec: satrec
          };
          
          createdCount++;
          
          // Get current position
          const currentTime = new Date();
          const result = satellite.propagate(satrec, currentTime);
          
          if (result.position && !isNaN(result.position.x)) {
            // Convert ECI to world coordinates
            const x = result.position.x;
            const y = result.position.z;
            const z = -result.position.y;
            
            satelliteMesh.position.set(x, y, z);
            
            // Calculate altitude for color
            const radius = Math.sqrt(
              result.position.x * result.position.x + 
              result.position.y * result.position.y + 
              result.position.z * result.position.z
            );
            const altitude = radius - 6371;
            
            // Color by altitude with bright colors
            let color;
            if (altitude > 600) {
              color = 0xff0000; // Red
            } else if (altitude > 550) {
              color = 0xffff00; // Yellow
            } else if (altitude > 500) {
              color = 0x00ff00; // Green
            } else {
              color = 0x0000ff; // Blue
            }
            
            material.color.setHex(color);
            
            scene3D.add(satelliteMesh);
            satellites3D.push(satelliteMesh);
            positionedCount++;
            
          } else {
            // Fallback positioning
            const alt = 550 + (index % 10) * 30;
            const radius = 6371 + alt;
            const angle = (index / Math.max(tleList.length, 1)) * 2 * Math.PI;
            const inclination = (43 + (index % 15)) * Math.PI / 180;
            
            const x = radius * Math.cos(angle) * Math.cos(inclination);
            const y = radius * Math.sin(inclination);
            const z = radius * Math.sin(angle) * Math.cos(inclination);
            
            satelliteMesh.position.set(x, y, z);
            
            let color = alt > 600 ? 0xff0000 : alt > 550 ? 0xffff00 : 0x00ff00;
            material.color.setHex(color);
            
            scene3D.add(satelliteMesh);
            satellites3D.push(satelliteMesh);
            positionedCount++;
          }
          
        } catch (e) {
          updateTerminalLog('3D', `ERROR creating satellite ${index}: ${e.message}`);
        }
      });
      
      const globeSatsEl = document.getElementById('globe-sats');
      if (globeSatsEl) globeSatsEl.textContent = positionedCount;
      
      updateTerminalLog('3D', `CREATION COMPLETE: ${createdCount} created, ${positionedCount} positioned`);
      updateTerminalLog('3D', `Scene children count: ${scene3D.children.length}`);
      
      // Force render
      if (renderer3D && scene3D && camera3D) {
        renderer3D.render(scene3D, camera3D);
        updateTerminalLog('3D', 'Initial render completed');
      }
    }
    
    function update3DSatellites() {
      if (satellites3D.length === 0 || orbitsPaused) return;
      
      const currentTime = new Date();
      let updated = 0;
      
      satellites3D.forEach((sat) => {
        const rec = sat.userData.rec;
        if (!rec) return;
        
        try {
          const result = satellite.propagate(rec, currentTime);
          if (!result.position) return;
          
          const pos = result.position;
          if (isNaN(pos.x) || isNaN(pos.y) || isNaN(pos.z)) return;
          
          // Update position
          sat.position.set(pos.x, pos.z, -pos.y);
          
          // Calculate altitude for color coding
          const radius = Math.sqrt(pos.x * pos.x + pos.y * pos.y + pos.z * pos.z);
          const altitude = radius - 6371;
          
          // Color by altitude or selection
          let color;
          const isSelected = selectedSatellite && selectedSatellite.index === sat.userData.index;
          
          if (isSelected) {
            color = 0xffffff; // BRANCO para selecionado
          } else if (altitude > 600) {
            color = 0xff0000; // Red for high altitude
          } else if (altitude > 550) {
            color = 0xffff00; // Yellow for medium altitude
          } else if (altitude > 500) {
            color = 0x00ff00; // Green for normal altitude
          } else {
            color = 0x0000ff; // Blue for low altitude
          }
          
          if (sat.material && sat.material.color && sat.material.color.setHex) {
            sat.material.color.setHex(color);
          }
          
          updated++;
          
        } catch (e) {
          // Silent error handling for performance
        }
      });
    }
    
    function setupGlobeControls() {
      const container = document.getElementById('globe');
      if (!container || !renderer3D) return;
      
      let mouseDown = false;
      let mouseX = 0;
      let mouseY = 0;
      
      const canvas = renderer3D.domElement;
      
      canvas.addEventListener('mousedown', (e) => {
        mouseDown = true;
        mouseX = e.clientX;
        mouseY = e.clientY;
        e.preventDefault();
      });
      
      canvas.addEventListener('mousemove', (e) => {
        if (!mouseDown || !camera3D) return;
        
        const deltaX = e.clientX - mouseX;
        const deltaY = e.clientY - mouseY;
        
        const spherical = new THREE.Spherical();
        spherical.setFromVector3(camera3D.position);
        spherical.theta -= deltaX * 0.01;
        spherical.phi += deltaY * 0.01;
        spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
        camera3D.position.setFromSpherical(spherical);
        camera3D.lookAt(0, 0, 0);
        
        mouseX = e.clientX;
        mouseY = e.clientY;
      });
      
      canvas.addEventListener('mouseup', () => {
        mouseDown = false;
      });
      
      canvas.addEventListener('wheel', (e) => {
        if (!camera3D) return;
        const scale = e.deltaY > 0 ? 1.1 : 0.9;
        camera3D.position.multiplyScalar(scale);
        camera3D.position.clampLength(8000, 80000);
        e.preventDefault();
      });
      
      updateTerminalLog('3D', 'Globe controls configured');
    }
    
    let lastTime = 0;
    let frameCount = 0;
    
    function animate3D() {
      if (currentView !== 'globe' || !globe3D || !renderer3D) {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        return;
      }
      
      animationId = requestAnimationFrame(animate3D);
      
      // FPS counter
      frameCount++;
      const currentTime = performance.now();
      if (currentTime >= lastTime + 1000) {
        const fps = document.getElementById('globe-fps');
        if (fps) fps.textContent = frameCount;
        frameCount = 0;
        lastTime = currentTime;
      }
      
      // Time display
      const timeEl = document.getElementById('globe-time');
      if (timeEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('pt-BR');
      }
      
      // Auto rotate
      if (autoRotate && earthMesh) {
        earthMesh.rotation.y += 0.002;
      }
      
      // Update satellites
      if (!orbitsPaused) {
        update3DSatellites();
      }
      
      // Render
      if (renderer3D && scene3D && camera3D) {
        renderer3D.render(scene3D, camera3D);
      }
    }
    
    // ==================== CÁLCULOS DE SATÉLITE ====================
    
    function getOrbitType(altitude) {
      if (altitude < 2000) {
        return 'LEO';
      } else if (altitude < 35786) {
        return 'MEO';
      } else {
        return 'HEO';
      }
    }
    
    function calculateTrajectory(rec, steps = 20, timeStepMinutes = 10) {
      const trajectoryPoints = [];
      const currentTime = new Date();
      
      for (let i = 0; i <= steps; i++) {
        const futureTime = new Date(currentTime.getTime() + i * timeStepMinutes * 60000);
        const st = getSatState(rec, futureTime);
        
        if (st) {
          trajectoryPoints.push([st.lat, st.lon]);
        }
      }
      
      return trajectoryPoints;
    }
    
    function shouldShowSatellite(st, isVisible) {
      const orbitType = getOrbitType(st.alt);
      
      // Se "All Possible" não estiver marcado, não mostra nada
      if (!config.filters.all) {
        return false;
      }
      
      // Se é visível mas o filtro "visible" está desmarcado, não mostra
      if (isVisible && !config.filters.visible) {
        return false;
      }
      
      // Check orbit type filters
      if (!config.filters[orbitType]) {
        return false;
      }
      
      return true;
    }
    
    function getSatState(rec, time = new Date()) {
      try {
        if (!rec) return null;
        
        const gmst = satellite.gstime(time);
        const pv = satellite.propagate(rec, time);
        
        if (!pv || !pv.position || pv.position === false) return null;
        
        const eci = pv.position;
        const vel = pv.velocity || {x: 0, y: 0, z: 0};
        const gd = satellite.eciToGeodetic(eci, gmst);
        
        const lat = satellite.radiansToDegrees(gd.latitude);
        const lon = satellite.radiansToDegrees(gd.longitude);
        const alt = gd.height;
        
        const speed = Math.sqrt(vel.x**2 + vel.y**2 + vel.z**2);
        
        // Calculate look angles from observer
        const obsGd = {
          latitude: satellite.degreesToRadians(obs.lat),
          longitude: satellite.degreesToRadians(obs.lon),
          height: 0
        };
        
        const satEcf = satellite.eciToEcf(eci, gmst);
        const look = satellite.ecfToLookAngles(obsGd, satEcf);
        
        const az = satellite.radiansToDegrees(look.azimuth);
        const el = satellite.radiansToDegrees(look.elevation);
        const range = look.rangeSat;
        
        return { lat, lon, alt, az, el, range, speed };
      } catch (err) {
        return null;
      }
    }
    
    function calculateLinkBudget(elevationDeg) {
      const FREQ = 11.5e9; // Hz (Ku-band downlink)
      const EIRP = 35; // dBW (satellite EIRP)
      const GAIN = 33; // dBi (user terminal gain)
      
      // Free space path loss calculation
      const distance = 550 / Math.sin(Math.max(elevationDeg, 1) * Math.PI / 180);
      const FSPL = 20 * Math.log10(distance * 1000) + 20 * Math.log10(FREQ) + 92.45;
      
      // Atmospheric losses (higher at low elevations)
      const atmosphericLoss = 0.5 / Math.sin(Math.max(elevationDeg, 5) * Math.PI / 180);
      
      const rxPower = EIRP - FSPL - atmosphericLoss + GAIN;
      
      return { rxPower, FSPL };
    }
    
    // ==================== ATUALIZAÇÃO DE SATÉLITES CORRIGIDA ====================
    
    function updateSatellites() {
      if (isDrawing) return;
      isDrawing = true;
      
      const startTime = performance.now();
      
      layerGroup.clearLayers();
      footprintGroup.clearLayers();
      trajectoryGroup.clearLayers();
      
      let visible = 0;
      let drawn = 0;
      let filtered = 0;
      let selectedMarker = null; // Para manter referência do marker selecionado
      const MAX_DRAW = 1000;
      const step = Math.ceil(tleList.length / MAX_DRAW);
      
      for (let i = 0; i < tleList.length; i += step) {
        const t = tleList[i];
        const rec = satRecs[i];
        
        if (!rec) continue;
        
        const st = getSatState(rec);
        if (!st) continue;
        
        const isVisible = st.el >= obs.elevMin;
        const isSelected = selectedSatellite && selectedSatellite.index === i;
        
        // Apply filters (but always show selected satellite)
        if (!shouldShowSatellite(st, isVisible) && !isSelected) {
          filtered++;
          continue;
        }
        
        // Color by altitude with better visibility for "all possible"
        let color, radius, opacity;
        
        if (isSelected) {
          color = '#ffffff'; // BRANCO para selecionado
          radius = 6;
          opacity = 1.0;
        } else if (isVisible) {
          // Color by altitude for visible satellites
          if (st.alt > 600) {
            color = '#ff0000'; // Red: high altitude
          } else if (st.alt > 550) {
            color = '#ffff00'; // Yellow: medium altitude
          } else if (st.alt > 500) {
            color = '#00ff00'; // Green: normal altitude
          } else {
            color = '#0000ff'; // Blue: low altitude
          }
          radius = 3;
          opacity = 0.8;
          visible++;
        } else {
          // Not visible satellites - darker green when "all possible" is on
          color = config.filters.all ? '#006600' : '#004400'; // Darker green for better visibility
          radius = 2;
          opacity = config.filters.all ? 0.6 : 0.3; // More opaque when showing all
        }
        
        const marker = L.circleMarker([st.lat, st.lon], {
          radius: radius,
          weight: isSelected ? 3 : 1,
          color: color,
          fillColor: color,
          fillOpacity: opacity,
          opacity: opacity + 0.2,
          className: isSelected ? 'selected-satellite' : ''
        });
        
        const linkBudget = calculateLinkBudget(st.el);
        const orbitType = getOrbitType(st.alt);
        
        // Create popup content
        const popupContent = `
          <div class="terminal-popup">
<strong>[${t.name || "SAT"}]</strong>
NORAD: ${t.noradId}
ORBIT: ${orbitType}
ALT..: ${st.alt.toFixed(0)} km
ELEV.: ${st.el.toFixed(1)}°
AZIM.: ${st.az.toFixed(1)}°
RANGE: ${(st.range/1000).toFixed(0)} km
SPEED: ${st.speed.toFixed(2)} km/s
FSPL.: ${linkBudget.FSPL.toFixed(1)} dB
          </div>
        `;
        
        marker.bindPopup(popupContent, {
          autoClose: false,
          closeOnEscapeKey: false, // Não fechar com ESC para manter persistente
          keepInView: true,
          autoPan: false
        });
        
        // Store the actual index in the marker for correct selection
        marker.satelliteIndex = i;
        marker.satelliteData = { t, rec, st };
        
        marker.on('click', (e) => {
          const clickedIndex = e.target.satelliteIndex;
          const clickedData = e.target.satelliteData;
          
          selectSatellite(clickedIndex, clickedData.t, clickedData.rec, clickedData.st);
          
          // Manter popup aberto e armazenar referência
          selectedPopup = e.target;
          e.target.openPopup();
          
          updateTerminalLog('CLICK', `Selected satellite ${clickedIndex}: ${clickedData.t.name} (${getOrbitType(clickedData.st.alt)})`);
        });
        
        // Se este é o satélite selecionado, armazena para manter popup
        if (isSelected) {
          selectedMarker = marker;
        }
        
        marker.addTo(layerGroup);
        drawn++;
        
        // Trajectories
        if (config.showTrajectory) {
          const shouldShowTraj = config.trajectorySelectedOnly ? isSelected : true;
          
          if (shouldShowTraj) {
            const trajectoryPoints = calculateTrajectory(rec, 15, 12);
            
            if (trajectoryPoints.length > 1) {
              const trajectoryColor = isSelected ? '#ffffff' : color; // Branco para trajetória selecionada
              
              L.polyline(trajectoryPoints, {
                color: trajectoryColor,
                weight: isSelected ? 3 : 2,
                opacity: isSelected ? 0.8 : 0.5,
                dashArray: isSelected ? '5,0' : '10,5',
                interactive: false
              }).addTo(trajectoryGroup);
            }
          }
        }
        
        // Footprints
        if (config.showFootprints && isVisible) {
          // Se "Selected Only" estiver marcado, só mostra footprint do satélite selecionado
          const shouldShowFootprint = config.footprintSelectedOnly ? isSelected : (visible <= config.maxFootprints);
          
          if (shouldShowFootprint) {
            const footprintRadius = calculateFootprintRadius(st.alt, obs.elevMin);
            L.circle([st.lat, st.lon], {
              radius: footprintRadius * 1000,
              color: isSelected ? '#ffffff' : '#00ff00', // Branco para footprint selecionado
              weight: 2,
              opacity: 0.6,
              fillColor: isSelected ? '#ffffff' : '#00ff00',
              fillOpacity: 0.1,
              interactive: false,
              dashArray: '5,10'
            }).addTo(footprintGroup);
          }
        }
      }
      
      // MANTER POPUP ABERTO para satélite selecionado
      if (selectedMarker && selectedSatellite) {
        // Atualizar posição do popup e reabrir se necessário
        setTimeout(() => {
          if (selectedMarker && !selectedMarker.isPopupOpen()) {
            selectedMarker.openPopup();
          }
        }, 100);
      }
      
      const elapsed = performance.now() - startTime;
      
      // Update mission status
      document.getElementById("visibleInfo").innerHTML = `
        <div class="data-row">
          <span class="data-label">STATUS:</span>
          <span class="data-value good">OPERATIONAL</span>
        </div>
        <div class="data-row">
          <span class="data-label">RENDER:</span>
          <span class="data-value">${elapsed.toFixed(0)} ms</span>
        </div>
        <div class="data-row">
          <span class="data-label">FILTERED:</span>
          <span class="data-value">${filtered}</span>
        </div>
      `;
      
      updateStats(visible, drawn, satRecs.filter(r => r !== null).length);
      isDrawing = false;
    }
    
    function calculateFootprintRadius(altKm, elevMinDeg) {
      const Re = 6371; // Earth radius km
      const h = altKm;
      const e = elevMinDeg * Math.PI / 180;
      const psi = Math.acos((Re/(Re+h)) * Math.cos(e)) - e;
      return Re * psi;
    }
    
    function selectSatellite(index, t, rec, st) {
      selectedSatellite = { index, tle: t, rec, state: st };
      
      const linkBudget = calculateLinkBudget(st.el);
      const orbitType = getOrbitType(st.alt);
      
      // Update target overlay
      const targetInfo = document.getElementById('targetInfo');
      targetInfo.innerHTML = `
        <div class="data-row">
          <span class="data-label">SAT ID:</span>
          <span class="data-value">${t.name}</span>
        </div>
        <div class="data-row">
          <span class="data-label">ORBIT:</span>
          <span class="data-value">${orbitType}</span>
        </div>
        <div class="data-row">
          <span class="data-label">ELEV:</span>
          <span class="data-value">${st.el.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">AZIM:</span>
          <span class="data-value">${st.az.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">RANGE:</span>
          <span class="data-value">${(st.range/1000).toFixed(0)} km</span>
        </div>
      `;
      
      // Update satellite info panel
      updateSatelliteInfo(index, st, linkBudget);
      updateRFAnalysis(st, linkBudget);
      updateOrbitalInfo(t, rec);
      
      updateTerminalLog('SELECT', `Satellite selected: ${t.name} [${t.noradId}] - ${orbitType} orbit`);
    }
    
    function updateSatelliteInfo(index, st, linkBudget) {
      const satInfo = document.getElementById('sat-info');
      const t = tleList[index];
      
      if (!t || !st) {
        updateTerminalLog('SAT', 'Invalid satellite selection');
        return;
      }
      
      const noradId = t.line1 ? t.line1.substring(2, 7) : t.noradId;
      
      satInfo.innerHTML = `
        <div class="sat-info-item">
          <span class="sat-info-label">NORAD</span>
          <span class="sat-info-value">${noradId}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">NAME</span>
          <span class="sat-info-value">${(t.name || "SAT").substring(0, 12)}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ALTITUDE</span>
          <span class="sat-info-value">${st.alt.toFixed(0)} km</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">VELOCITY</span>
          <span class="sat-info-value">${st.speed.toFixed(2)} km/s</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ELEVATION</span>
          <span class="sat-info-value">${st.el.toFixed(1)}°</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">AZIMUTH</span>
          <span class="sat-info-value">${st.az.toFixed(1)}°</span>
        </div>
      `;
    }
    
    function updateRFAnalysis(st, linkBudget) {
      document.getElementById('rf-power').textContent = `${linkBudget.rxPower.toFixed(1)} dBm`;
      document.getElementById('rf-fspl').textContent = `${linkBudget.FSPL.toFixed(1)} dB`;
      
      // Link status determination
      let status, statusClass;
      if (st.el < obs.elevMin) {
        status = 'BELOW HORIZON';
        statusClass = 'critical';
      } else if (linkBudget.rxPower > -80) {
        status = 'EXCELLENT';
        statusClass = 'good';
      } else if (linkBudget.rxPower > -90) {
        status = 'GOOD';
        statusClass = 'good';
      } else if (linkBudget.rxPower > -100) {
        status = 'MARGINAL';
        statusClass = 'warning';
      } else {
        status = 'POOR';
        statusClass = 'critical';
      }
      
      const statusEl = document.getElementById('rf-status');
      statusEl.textContent = status;
      statusEl.className = `data-value ${statusClass}`;
    }
    
    function updateOrbitalInfo(t, rec) {
      const orbitalInfo = document.getElementById('orbital-info');
      
      if (!t || !rec) {
        orbitalInfo.innerHTML = `
          <div class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">STATUS</span>
              <span class="sat-info-value">NO SATELLITE</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ACTION</span>
              <span class="sat-info-value">SELECT SAT</span>
            </div>
          </div>
        `;
        return;
      }
      
      // Extract orbital elements from TLE
      const line1 = t.line1;
      const line2 = t.line2;
      
      if (!line1 || !line2) {
        orbitalInfo.innerHTML = `
          <div class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">ERROR</span>
              <span class="sat-info-value">INVALID TLE</span>
            </div>
          </div>
        `;
        return;
      }
      
      const inclination = parseFloat(line2.substring(8, 16));
      const raan = parseFloat(line2.substring(17, 25));
      const eccentricity = parseFloat('0.' + line2.substring(26, 33));
      const argPerigee = parseFloat(line2.substring(34, 42));
      const meanAnomaly = parseFloat(line2.substring(43, 51));
      const meanMotion = parseFloat(line2.substring(52, 63));
      
      const period = 1440 / meanMotion; // minutes
      
      orbitalInfo.innerHTML = `
        <div class="sat-info-grid">
          <div class="sat-info-item">
            <span class="sat-info-label">INCLINATION</span>
            <span class="sat-info-value">${inclination.toFixed(2)}°</span>
          </div>
          <div class="sat-info-item">
            <span class="sat-info-label">RAAN</span>
            <span class="sat-info-value">${raan.toFixed(2)}°</span>
          </div>
          <div class="sat-info-item">
            <span class="sat-info-label">ECCENTRICITY</span>
            <span class="sat-info-value">${eccentricity.toFixed(6)}</span>
          </div>
          <div class="sat-info-item">
            <span class="sat-info-label">ARG PERIGEE</span>
            <span class="sat-info-value">${argPerigee.toFixed(2)}°</span>
          </div>
          <div class="sat-info-item">
            <span class="sat-info-label">MEAN ANOMALY</span>
            <span class="sat-info-value">${meanAnomaly.toFixed(2)}°</span>
          </div>
          <div class="sat-info-item">
            <span class="sat-info-label">PERIOD</span>
            <span class="sat-info-value">${period.toFixed(1)} min</span>
          </div>
        </div>
      `;
    }
    
    // ==================== CONTROLES ====================
    
    function switchView(view) {
      currentView = view;
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      document.querySelectorAll('.view-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(view + '-view').classList.add('active');
      
      if (view === 'globe') {
        updateTerminalLog('VIEW', 'Switching to 3D Globe view');
        if (!globe3D) {
          updateTerminalLog('3D', 'Globe not initialized, starting initialization...');
          setTimeout(() => init3DGlobe(), 200);
        } else {
          updateTerminalLog('3D', 'Globe already initialized, resuming animation');
          animate3D();
        }
      }
      
      updateTerminalLog('VIEW', `Display mode: ${view.toUpperCase()}`);
    }
    
    function resetGlobeView() {
      if (camera3D) {
        camera3D.position.set(15000, 10000, 15000);
        camera3D.lookAt(0, 0, 0);
      }
      if (earthMesh) {
        earthMesh.rotation.set(0, 0, 0);
      }
      updateTerminalLog('3D', 'Tactical view reset');
    }
    
    function toggleRotation() {
      autoRotate = !autoRotate;
      const rotEl = document.getElementById('globe-rotation');
      if (rotEl) rotEl.textContent = autoRotate ? 'ON' : 'OFF';
      updateTerminalLog('3D', `Auto-rotation ${autoRotate ? 'enabled' : 'disabled'}`);
    }
    
    // ==================== UTILITÁRIOS ====================
    
    function updateTerminalLog(type, message) {
      const time = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
      
      const terminal = document.getElementById('terminalOutput');
      if (terminal) {
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.innerHTML = `<span class="time">[${time}]</span> <span class="type">[${type}]</span> <span class="message">${message}</span>`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
        
        while (terminal.children.length > 50) {
          terminal.removeChild(terminal.firstChild);
        }
      }
      
      console.log(`%c[${time}] [${type}] ${message}`, "color: #00ff00; font-family: monospace");
    }
    
    function updateStats(visible, tracked, total) {
      document.getElementById('stat-visible').textContent = visible || 0;
      document.getElementById('stat-tracked').textContent = tracked || 0;
      document.getElementById('stat-total').textContent = total || 0;
    }
    
    // ==================== EVENT LISTENERS ====================
    
    window.addEventListener('resize', () => {
      if (renderer3D && camera3D) {
        const container = document.getElementById('globe');
        if (container) {
          camera3D.aspect = container.clientWidth / container.clientHeight;
          camera3D.updateProjectionMatrix();
          renderer3D.setSize(container.clientWidth, container.clientHeight);
        }
      }
    });
    
    // Export functions
    window.switchView = switchView;
    window.resetGlobeView = resetGlobeView;
    window.toggleRotation = toggleRotation;
    
    // ==================== INICIALIZAÇÃO ====================
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
