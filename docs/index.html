<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>STARLINK TACTICAL OPERATIONS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Satellite.js -->
  <script src="https://unpkg.com/satellite.js@5.0.0/dist/satellite.min.js"></script>
  
  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #000000;
      color: #999999;
      font-size: 12px;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      height: 50px;
      background: #1a1a1a;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      background: #ff0000;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
      50% { opacity: 0.3; box-shadow: 0 0 0 10px rgba(255,0,0,0); }
    }
    
    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    
    .header-stats {
      display: flex;
      gap: 30px;
      font-family: 'Share Tech Mono', monospace;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-size: 20px;
      color: #ffffff;
      font-weight: 500;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666666;
      text-transform: uppercase;
    }
    
    #meta {
      font-size: 11px;
      color: #00ff00;
      margin-left: 20px;
    }
    
    /* View Tabs */
    .view-tabs {
      height: 40px;
      background: #111111;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 10px;
    }
    
    .tab-btn {
      padding: 8px 20px;
      background: #1a1a1a;
      border: 1px solid #333333;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      background: #222222;
      color: #ffffff;
    }
    
    .tab-btn.active {
      background: #990000;
      border-color: #ff0000;
      color: #ffffff;
    }
    
    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background: #0a0a0a;
    }
    
    /* Left Panel */
    .left-panel {
      width: 320px;
      background: #111111;
      border-right: 1px solid #333333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .left-panel-scrollable {
      flex: 1;
      overflow-y: auto;
    }
    
    .panel-section {
      border-bottom: 1px solid #222222;
    }
    
    .section-title {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
    }
    
    .section-content {
      padding: 15px;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    .control-label {
      display: block;
      margin-bottom: 5px;
      color: #666666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .control-input {
      width: 100%;
      padding: 6px 10px;
      background: #000000;
      border: 1px solid #333333;
      color: #ffffff;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #ff0000;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #ff0000;
    }
    
    .checkbox-group label {
      color: #999999;
      text-transform: uppercase;
      font-size: 11px;
    }
    
    .btn {
      width: 100%;
      padding: 8px;
      background: #990000;
      border: 1px solid #ff0000;
      color: #ffffff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    
    .btn:hover {
      background: #ff0000;
      box-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    
    .btn.active {
      background: #00ff00;
      border-color: #00ff00;
      color: #000000;
    }
    
    /* Terminal */
    .terminal {
      height: 120px;
      background: #000000;
      border: 1px solid #222222;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
    }
    
    .terminal-line {
      margin: 2px 0;
      color: #999999;
    }
    
    .terminal-line .time { color: #666666; }
    .terminal-line .type { color: #ff0000; }
    .terminal-line .message { color: #ffffff; }
    
    /* View Container */
    .view-container {
      flex: 1;
      position: relative;
      background: #000000;
    }
    
    .view-content {
      width: 100%;
      height: 100%;
      display: none;
    }
    
    .view-content.active {
      display: block;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    #globe {
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0a1a 0%, #000000 100%);
    }
    
    /* Map Overlay */
    .map-overlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 15px;
      min-width: 200px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .overlay-title {
      color: #ff0000;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .data-row {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
    }
    
    .data-label {
      color: #666666;
    }
    
    .data-value {
      color: #ffffff;
    }
    
    .data-value.good { color: #00ff00; }
    .data-value.warning { color: #ffaa00; }
    .data-value.critical { color: #ff0000; }
    
    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 10px;
      font-size: 11px;
    }
    
    .legend-title {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border: 1px solid #333333;
    }
    
    /* Right Panel - RF Analysis */
    .right-panel {
      width: 400px;
      background: #111111;
      border-left: 1px solid #333333;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    
    .info-card {
      border-bottom: 1px solid #222222;
      flex-shrink: 0;
    }
    
    .card-header {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #ffffff;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .card-content {
      padding: 15px;
    }
    
    .sat-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .sat-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .sat-info-label {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
    }
    
    .sat-info-value {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .terminal-text {
      font-family: 'Share Tech Mono', monospace;
      white-space: pre;
      line-height: 1.3;
      color: #00ff00;
      font-size: 11px;
    }
    
    /* Leaflet Popup Dark Theme */
    .leaflet-popup-content-wrapper {
      background: #000000 !important;
      border: 1px solid #00ff00 !important;
      border-radius: 0 !important;
      box-shadow: 0 0 10px rgba(0,255,0,0.3) !important;
    }
    
    .leaflet-popup-content {
      color: #ffffff !important;
      font-family: 'Share Tech Mono', monospace !important;
      font-size: 11px !important;
      margin: 10px !important;
      line-height: 1.4 !important;
    }
    
    .leaflet-popup-tip {
      background: #000000 !important;
      border: 1px solid #00ff00 !important;
      box-shadow: none !important;
    }
    
    .leaflet-popup-close-button {
      color: #00ff00 !important;
      font-size: 16px !important;
      font-weight: bold !important;
      text-shadow: 0 0 3px #00ff00 !important;
    }
    
    .leaflet-popup-close-button:hover {
      color: #ffffff !important;
      background: rgba(0,255,0,0.2) !important;
    }
    
    .terminal-popup {
      white-space: pre;
      line-height: 1.4;
      color: #ffffff;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #000000; }
    ::-webkit-scrollbar-thumb { background: #333333; }
    ::-webkit-scrollbar-thumb:hover { background: #666666; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <div class="status-indicator"></div>
      <h1>Starlink Tactical Operations</h1>
      <div id="meta">[INITIALIZING...]</div>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-visible">0</div>
        <div class="stat-label">Visible</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tracked">0</div>
        <div class="stat-label">Tracked</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total</div>
      </div>
    </div>
  </div>

  <!-- View Tabs -->
  <div class="view-tabs">
    <button class="tab-btn active" onclick="switchView('map')">2D MERCATOR</button>
    <button class="tab-btn" onclick="switchView('globe')">3D GLOBE</button>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Panel - Controls & Log -->
    <div class="left-panel">
      <div class="left-panel-scrollable">
        <div class="panel-section">
          <div class="section-title">Target Operation</div>
          <div class="section-content">
            <div class="control-group">
              <label class="control-label">Latitude</label>
              <input type="number" id="lat" class="control-input" value="-27.588" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Longitude</label>
              <input type="number" id="lon" class="control-input" value="-48.613" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Min Elevation (°)</label>
              <input type="number" id="elevMin" class="control-input" value="25" min="0" max="90" step="5">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showFootprints" checked>
              <label for="showFootprints">Show Footprints</label>
            </div>
            <button class="btn" id="btnApply">EXECUTE</button>
            <button class="btn" id="btnPause">PAUSE ORBITS</button>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">3D Controls</div>
          <div class="section-content">
            <button class="btn" onclick="resetGlobeView()">RESET VIEW</button>
            <button class="btn" onclick="toggleRotation()">AUTO ROTATE</button>
            <div style="margin-top: 10px;">
              <label class="control-label">Orbit Speed</label>
              <input type="range" id="orbitSpeed" min="1" max="100" value="10" style="width: 100%;">
            </div>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">Mission Status</div>
          <div class="section-content">
            <div id="visibleInfo" style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
              <div class="data-row">
                <span class="data-label">STATUS:</span>
                <span class="data-value">INITIALIZING</span>
              </div>
              <div class="data-row">
                <span class="data-label">RENDER:</span>
                <span class="data-value">0 ms</span>
              </div>
              <div class="data-row">
                <span class="data-label">LINK:</span>
                <span class="data-value good">OPERATIONAL</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- System Log -->
        <div class="panel-section">
          <div class="section-title">System Log</div>
          <div class="section-content" style="padding: 0;">
            <div class="terminal" id="terminalOutput"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- View Container -->
    <div class="view-container">
      <!-- 2D Map View -->
      <div id="map-view" class="view-content active">
        <div id="map"></div>
        
        <!-- Map Overlay -->
        <div class="map-overlay">
          <div class="overlay-title">Target Details</div>
          <div id="targetInfo">
            <div class="data-row">
              <span class="data-label">SAT ID:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">ELEV:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">AZIM:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">RANGE:</span>
              <span class="data-value">---</span>
            </div>
          </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
          <div class="legend-title">Satellite Status</div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            <span style="color: #999999;">VISIBLE</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff00ff;"></div>
            <span style="color: #999999;">SELECTED</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #333333;"></div>
            <span style="color: #999999;">INACTIVE</span>
          </div>
        </div>
      </div>
      
      <!-- 3D Globe View -->
      <div id="globe-view" class="view-content">
        <div id="globe"></div>
        
        <!-- Globe Info -->
        <div class="map-overlay">
          <div class="overlay-title">Globe Statistics</div>
          <div id="globeInfo">
            <div class="data-row">
              <span class="data-label">SATELLITES:</span>
              <span class="data-value" id="globe-sats">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">FPS:</span>
              <span class="data-value" id="globe-fps">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">ROTATION:</span>
              <span class="data-value" id="globe-rotation">OFF</span>
            </div>
            <div class="data-row">
              <span class="data-label">ORBITS:</span>
              <span class="data-value" id="globe-orbits">ACTIVE</span>
            </div>
            <div class="data-row">
              <span class="data-label">TIME:</span>
              <span class="data-value" id="globe-time">00:00:00</span>
            </div>
          </div>
        </div>
        
        <!-- 3D Legend -->
        <div class="legend">
          <div class="legend-title">Altitude Color Code</div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            <span style="color: #999999;">HIGH (>600km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffff00;"></div>
            <span style="color: #999999;">MEDIUM (550-600km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            <span style="color: #999999;">NORMAL (500-550km)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #0000ff;"></div>
            <span style="color: #999999;">LOW (<500km)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Satellite Data -->
    <div class="right-panel">
      <!-- Selected Satellite Data -->
      <div class="info-card">
        <div class="card-header">Satellite Data</div>
        <div class="card-content">
          <div id="sat-info" class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">NORAD</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">NAME</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ALTITUDE</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">VELOCITY</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ELEVATION</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">AZIMUTH</span>
              <span class="sat-info-value">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- RF Link Analysis -->
      <div class="info-card">
        <div class="card-header">RF Link Analysis</div>
        <div class="card-content">
          <div style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
            <div class="data-row">
              <span class="data-label">FREQ DL:</span>
              <span class="data-value">10.7-12.7 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">FREQ UL:</span>
              <span class="data-value">14.0-14.5 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">RX POWER:</span>
              <span class="data-value" id="rf-power">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">FSPL:</span>
              <span class="data-value" id="rf-fspl">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">LINK STATUS:</span>
              <span class="data-value" id="rf-status">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Orbital Elements -->
      <div class="info-card">
        <div class="card-header">Orbital Elements</div>
        <div class="card-content">
          <div id="orbital-info" style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
            <div class="terminal-text">NO SATELLITE SELECTED
Click on a satellite to view
orbital parameters and RF data</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ==================== CONFIGURAÇÃO GLOBAL ====================
    const DATA_URL = "data/starlink_tle.json";
    const META_URL = "data/meta.json";
    const REFRESH_MS = 3000;
    
    // TLEs de fallback válidos (Gen2 Starlink)
    const FALLBACK_TLEs = [
      {
        "name": "STARLINK-30440",
        "noradId": "57812",
        "line1": "1 57812U 23126W   24219.25000000  .00000832  00000-0  73125-4 0  9995",
        "line2": "2 57812  43.0010 315.8972 0.0003456 268.7432  91.3456 15.02531234 52348"
      },
      {
        "name": "STARLINK-30441",
        "noradId": "57813",
        "line1": "1 57813U 23126X   24219.26000000  .00000945  00000-0  81234-4 0  9993",
        "line2": "2 57813  43.0012 316.1234 0.0002987 269.1234  90.8765 15.02531456 52349"
      },
      {
        "name": "STARLINK-30442",
        "noradId": "57814",
        "line1": "1 57814U 23126Y   24219.27000000  .00000756  00000-0  69876-4 0  9991",
        "line2": "2 57814  43.0008 315.7654 0.0003789 268.9876  91.0123 15.02531678 52350"
      },
      {
        "name": "STARLINK-30443",
        "noradId": "57815",
        "line1": "1 57815U 23126Z   24219.28000000  .00000634  00000-0  58901-4 0  9990",
        "line2": "2 57815  43.0015 316.2345 0.0002456 269.3456  90.6543 15.02531890 52351"
      },
      {
        "name": "STARLINK-30444",
        "noradId": "57816",
        "line1": "1 57816U 23126AA  24219.29000000  .00000723  00000-0  65432-4 0  9992",
        "line2": "2 57816  43.0009 315.9876 0.0003123 268.8765  91.1234 15.02532102 52352"
      },
      {
        "name": "STARLINK-31001",
        "noradId": "58001",
        "line1": "1 58001U 23127A   24219.30000000  .00000512  00000-0  52341-4 0  9994",
        "line2": "2 58001  43.0020 325.1234 0.0002134 267.5678 92.4321 15.02530987 52360"
      },
      {
        "name": "STARLINK-31002",
        "noradId": "58002",
        "line1": "1 58002U 23127B   24219.31000000  .00000623  00000-0  61234-4 0  9996",
        "line2": "2 58002  43.0018 324.9876 0.0002567 268.1234 91.8765 15.02531123 52361"
      },
      {
        "name": "STARLINK-31003",
        "noradId": "58003",
        "line1": "1 58003U 23127C   24219.32000000  .00000734  00000-0  72567-4 0  9998",
        "line2": "2 58003  43.0016 324.7654 0.0002890 268.6789 91.3210 15.02531456 52362"
      }
    ];
    
    // ==================== ESTADO GLOBAL ====================
    let currentView = 'map';
    let globe3D = null;
    let scene3D, camera3D, renderer3D;
    let earthMesh, satellites3D = [];
    let autoRotate = false;
    let orbitsPaused = false;
    let animationId = null;
    
    let tleList = [];
    let satRecs = [];
    let map, layerGroup, footprintGroup;
    let obs = { lat: -27.588, lon: -48.613, elevMin: 25 };
    let selectedSatellite = null;
    let isDrawing = false;
    
    let config = {
      showFootprints: true,
      maxFootprints: 5
    };
    
    // ==================== INICIALIZAÇÃO ====================
    
    async function init() {
      updateTerminalLog("SYSTEM", "Initializing Starlink Tactical Operations...");
      
      console.log(`%c
╔═══════════════════════════════════════════╗
║     STARLINK TACTICAL OPERATIONS         ║
║         CENTRO OPERACIONAL TÁTICO        ║
╚═══════════════════════════════════════════╝
      `, "color: #00ff00; font-family: monospace");
      
      try {
        await loadSatelliteData();
        init2DMap();
        setupControls();
        setObserverLocation();
        startSimulation();
        updateTerminalLog("SYSTEM", "TACTICAL OPERATIONS CENTER ONLINE");
      } catch (e) {
        updateTerminalLog("ERROR", `Critical failure: ${e.message}`);
      }
    }
    
    async function loadSatelliteData() {
      updateTerminalLog("DATA", "Loading satellite orbital elements...");
      
      try {
        // Tentar carregar metadados primeiro
        try {
          const metaResponse = await fetch(META_URL);
          if (metaResponse.ok) {
            const meta = await metaResponse.json();
            document.getElementById("meta").innerHTML = 
              `[SATS: ${meta.count}] [SRC: ${meta.source}] [UPD: ${new Date(meta.updatedAt).toLocaleString('pt-BR')}]`;
            updateTerminalLog("DATA", `Metadata loaded: ${meta.count} satellites`);
          }
        } catch (e) {
          updateTerminalLog("WARNING", "Metadata not available");
        }
        
        // Tentar carregar dados externos
        const dataResponse = await fetch(DATA_URL);
        if (dataResponse.ok) {
          tleList = await dataResponse.json();
          updateTerminalLog("DATA", `${tleList.length} TLEs loaded from external source`);
        } else {
          throw new Error("External data not available");
        }
        
      } catch (e) {
        updateTerminalLog("WARNING", `External data unavailable: ${e.message}`);
        updateTerminalLog("DATA", "Switching to tactical fallback constellation...");
        
        tleList = FALLBACK_TLEs;
        document.getElementById("meta").innerHTML = `[FALLBACK MODE] [SATS: ${tleList.length}] [STATUS: TACTICAL]`;
        updateTerminalLog("DATA", `${tleList.length} tactical satellites loaded from fallback`);
      }
      
      // Processar TLEs
      updateTerminalLog("CALC", "Processing orbital elements with SGP4...");
      parseTLEData();
    }
    
    function parseTLEData() {
      satRecs = [];
      let validCount = 0;
      
      tleList.forEach((tle, index) => {
        try {
          if (!tle.line1 || !tle.line2) {
            updateTerminalLog("TLE", `Invalid TLE format for ${tle.name || index}`);
            satRecs.push(null);
            return;
          }
          
          const satrec = satellite.twoline2satrec(tle.line1, tle.line2);
          
          if (satrec.error) {
            updateTerminalLog("TLE", `SGP4 error for ${tle.name}: ${satrec.error}`);
            satRecs.push(null);
            return;
          }
          
          // Test propagation
          const testTime = new Date();
          const testResult = satellite.propagate(satrec, testTime);
          
          if (!testResult.position || isNaN(testResult.position.x)) {
            updateTerminalLog("TLE", `Propagation failed for ${tle.name}`);
            satRecs.push(null);
            return;
          }
          
          satRecs.push(satrec);
          validCount++;
          
        } catch (e) {
          updateTerminalLog("TLE", `Error processing ${tle.name}: ${e.message}`);
          satRecs.push(null);
        }
      });
      
      updateTerminalLog("CALC", `${validCount}/${tleList.length} satellites ready for tracking`);
      updateStats(0, 0, validCount);
    }
    
    function init2DMap() {
      updateTerminalLog("MAP", "Initializing tactical map system...");
      
      map = L.map("map", { 
        worldCopyJump: true,
        preferCanvas: true,
        renderer: L.canvas(),
        zoomControl: false
      }).setView([obs.lat, obs.lon], 3);
      
      // Dark tactical map
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© TACTICAL MAP',
        subdomains: 'abcd',
        maxZoom: 10,
        minZoom: 2
      }).addTo(map);
      
      // Layer groups
      layerGroup = L.layerGroup().addTo(map);
      footprintGroup = L.layerGroup().addTo(map);
      
      // Observer location marker
      const observerIcon = L.divIcon({
        html: '<div style="width: 12px; height: 12px; background: #ff0000; border: 2px solid #ffffff; border-radius: 50%; box-shadow: 0 0 10px #ff0000;"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });
      
      L.marker([obs.lat, obs.lon], { icon: observerIcon }).addTo(map)
        .bindPopup('<strong>TACTICAL BASE</strong><br>Campinas, SC<br>Status: OPERATIONAL');
      
      updateTerminalLog("MAP", "Tactical map system online");
    }
    
    function setupControls() {
      document.getElementById("btnApply").addEventListener('click', () => {
        setObserverLocation();
        updateSatellites();
        updateTerminalLog("CMD", "Tactical parameters updated");
      });
      
      // Pause button
      document.getElementById("btnPause").addEventListener('click', () => {
        orbitsPaused = !orbitsPaused;
        const btn = document.getElementById("btnPause");
        btn.textContent = orbitsPaused ? "RESUME ORBITS" : "PAUSE ORBITS";
        btn.classList.toggle('active', orbitsPaused);
        updateTerminalLog("CMD", `Orbital motion ${orbitsPaused ? 'PAUSED' : 'RESUMED'}`);
        
        // Update 3D globe display
        const globeOrbits = document.getElementById("globe-orbits");
        if (globeOrbits) {
          globeOrbits.textContent = orbitsPaused ? "PAUSED" : "ACTIVE";
        }
      });
      
      // Checkbox controls
      document.getElementById("showFootprints").addEventListener('change', (e) => {
        config.showFootprints = e.target.checked;
        updateTerminalLog("CONFIG", `Footprints ${config.showFootprints ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
    }
    
    function setObserverLocation() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const elevMin = parseFloat(document.getElementById('elevMin').value);
      
      if (isNaN(lat) || isNaN(lon) || isNaN(elevMin)) {
        updateTerminalLog('OBS', 'Invalid tactical coordinates');
        return;
      }
      
      obs = {
        lat: lat,
        lon: lon,
        elevMin: elevMin,
        height: 0
      };
      
      if (map) {
        map.setView([lat, lon], map.getZoom());
      }
      
      updateTerminalLog('OBS', `Tactical position: ${lat.toFixed(3)}°N, ${lon.toFixed(3)}°W, Elev>${elevMin}°`);
    }
    
    function startSimulation() {
      updateTerminalLog('SIM', 'Starting real-time orbital tracking...');
      
      // Main update loop
      setInterval(() => {
        if (!isDrawing && !orbitsPaused) {
          updateSatellites();
        }
      }, REFRESH_MS);
      
      // Initial update
      updateSatellites();
    }
    
    // ==================== GLOBO 3D ====================
    
    function init3DGlobe() {
      const container = document.getElementById('globe');
      if (!container) return;
      
      updateTerminalLog('3D', 'Initializing tactical 3D display...');
      
      // Clear previous content
      container.innerHTML = '';
      
      scene3D = new THREE.Scene();
      scene3D.fog = new THREE.Fog(0x000011, 10000, 30000);
      
      const aspect = container.clientWidth / container.clientHeight;
      camera3D = new THREE.PerspectiveCamera(60, aspect, 1, 100000);
      camera3D.position.set(15000, 10000, 15000);
      camera3D.lookAt(0, 0, 0);
      
      renderer3D = new THREE.WebGLRenderer({ 
        antialias: true,
        alpha: true
      });
      renderer3D.setSize(container.clientWidth, container.clientHeight);
      renderer3D.setClearColor(0x000011, 1);
      container.appendChild(renderer3D.domElement);
      
      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
      scene3D.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
      directionalLight.position.set(20000, 15000, 20000);
      scene3D.add(directionalLight);
      
      createEarth();
      create3DSatellites();
      setupGlobeControls();
      
      globe3D = true;
      animate3D();
      
      updateTerminalLog('3D', 'Tactical 3D display online');
    }
    
    function createEarth() {
      const earthGeometry = new THREE.SphereGeometry(6371, 64, 64);
      const earthMaterial = new THREE.MeshPhongMaterial({
        color: 0x2244aa,
        emissive: 0x112244,
        emissiveIntensity: 0.1,
        specular: 0x444444,
        shininess: 30,
        transparent: true,
        opacity: 0.9
      });
      
      earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
      scene3D.add(earthMesh);
      
      // Wireframe overlay
      const wireframeGeometry = new THREE.SphereGeometry(6371, 32, 16);
      const wireframeMaterial = new THREE.MeshBasicMaterial({
        color: 0x00aa00,
        wireframe: true,
        transparent: true,
        opacity: 0.3
      });
      const wireframeMesh = new THREE.Mesh(wireframeGeometry, wireframeMaterial);
      earthMesh.add(wireframeMesh);
      
      // Observer location
      const markerGeometry = new THREE.SphereGeometry(100, 16, 16);
      const markerMaterial = new THREE.MeshBasicMaterial({
        color: 0xff0000,
        emissive: 0xff0000,
        emissiveIntensity: 0.8
      });
      const observerMarker = new THREE.Mesh(markerGeometry, markerMaterial);
      
      const lat = obs.lat * Math.PI / 180;
      const lon = obs.lon * Math.PI / 180;
      const radius = 6371 + 50;
      
      observerMarker.position.x = radius * Math.cos(lat) * Math.cos(lon);
      observerMarker.position.y = radius * Math.sin(lat);
      observerMarker.position.z = radius * Math.cos(lat) * Math.sin(lon);
      
      scene3D.add(observerMarker);
    }
    
    function create3DSatellites() {
      const validSats = satRecs.filter(r => r !== null);
      if (validSats.length === 0) {
        updateTerminalLog('3D', 'No valid satellites for 3D display');
        setTimeout(create3DSatellites, 2000);
        return;
      }
      
      updateTerminalLog('3D', `Creating ${validSats.length} tactical 3D objects...`);
      
      // Clear existing satellites
      satellites3D.forEach(sat => {
        if (sat.parent) sat.parent.remove(sat);
        if (sat.material) sat.material.dispose();
        if (sat.geometry) sat.geometry.dispose();
      });
      satellites3D = [];
      
      const satGeometry = new THREE.SphereGeometry(150, 16, 16);
      
      satRecs.forEach((satrec, index) => {
        if (!satrec) return;
        
        try {
          const material = new THREE.MeshBasicMaterial({
            color: 0x00ff00,
            transparent: false,
            opacity: 1.0
          });
          material.emissive = new THREE.Color(0x00ff00);
          material.emissiveIntensity = 0.5;
          
          const satellite = new THREE.Mesh(satGeometry, material);
          satellite.userData = { 
            index: index,
            tle: tleList[index],
            rec: satrec,
            material: material
          };
          
          // Get current position
          const currentTime = new Date();
          const result = satellite.propagate(satrec, currentTime);
          
          if (result.position && !isNaN(result.position.x)) {
            // Convert ECI to 3D world coordinates
            satellite.position.set(
              result.position.x,
              result.position.z,
              -result.position.y
            );
          } else {
            // Fallback: place in orbit at typical Starlink altitude
            const alt = 550;
            const radius = 6371 + alt;
            const angle = (index / satRecs.length) * 2 * Math.PI;
            const inclination = 53 * Math.PI / 180; // Typical Starlink inclination
            
            satellite.position.set(
              radius * Math.cos(angle) * Math.cos(inclination),
              radius * Math.sin(inclination),
              radius * Math.sin(angle) * Math.cos(inclination)
            );
          }
          
          scene3D.add(satellite);
          satellites3D.push(satellite);
          
          updateTerminalLog('3D', `Satellite ${index} positioned at (${satellite.position.x.toFixed(0)}, ${satellite.position.y.toFixed(0)}, ${satellite.position.z.toFixed(0)})`);
          
        } catch (e) {
          updateTerminalLog('3D', `Error creating 3D object ${index}: ${e.message}`);
        }
      });
      
      const globeSatsEl = document.getElementById('globe-sats');
      if (globeSatsEl) globeSatsEl.textContent = satellites3D.length;
      updateTerminalLog('3D', `${satellites3D.length} tactical objects deployed in 3D space`);
    }
    
    function update3DSatellites() {
      if (satellites3D.length === 0 || orbitsPaused) return;
      
      const currentTime = new Date();
      let updated = 0;
      
      satellites3D.forEach((sat, satIndex) => {
        const rec = sat.userData.rec;
        if (!rec) return;
        
        try {
          const result = satellite.propagate(rec, currentTime);
          if (!result.position) return;
          
          const pos = result.position;
          if (isNaN(pos.x) || isNaN(pos.y) || isNaN(pos.z)) return;
          
          // Update position
          sat.position.set(pos.x, pos.z, -pos.y);
          
          // Calculate altitude for color coding
          const radius = Math.sqrt(pos.x * pos.x + pos.y * pos.y + pos.z * pos.z);
          const altitude = radius - 6371;
          
          // Color by altitude
          let color;
          if (altitude > 600) {
            color = 0xff0000; // Red for high altitude
          } else if (altitude > 550) {
            color = 0xffff00; // Yellow for medium altitude
          } else if (altitude > 500) {
            color = 0x00ff00; // Green for normal altitude
          } else {
            color = 0x0000ff; // Blue for low altitude
          }
          
          // Update visibility based on elevation
          if (obs) {
            const gmst = satellite.gstime(currentTime);
            const observerGd = {
              latitude: satellite.degreesToRadians(obs.lat),
              longitude: satellite.degreesToRadians(obs.lon),
              height: obs.height || 0
            };
            
            const positionEcf = satellite.eciToEcf(pos, gmst);
            const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);
            const elevation = satellite.radiansToDegrees(lookAngles.elevation);
            
            const isVisible = elevation >= (obs.elevMin || 25);
            
            if (sat.material && sat.material.color && sat.material.color.setHex) {
              if (isVisible) {
                sat.material.color.setHex(color);
                sat.material.emissive.setHex(color);
                sat.material.emissiveIntensity = 0.5;
              } else {
                sat.material.color.setHex(0x444444);
                sat.material.emissive.setHex(0x222222);
                sat.material.emissiveIntensity = 0.1;
              }
            }
          }
          
          updated++;
          
        } catch (e) {
          // Silent error handling for performance
        }
      });
      
      if (updated > 0) {
        updateTerminalLog('3D', `Updated ${updated} satellite positions`);
      }
    }
    
    function setupGlobeControls() {
      const container = document.getElementById('globe');
      if (!container) return;
      
      let mouseDown = false;
      let mouseX = 0;
      let mouseY = 0;
      
      container.addEventListener('mousedown', (e) => {
        mouseDown = true;
        mouseX = e.clientX;
        mouseY = e.clientY;
        e.preventDefault();
      });
      
      container.addEventListener('mousemove', (e) => {
        if (!mouseDown || !camera3D) return;
        
        const deltaX = e.clientX - mouseX;
        const deltaY = e.clientY - mouseY;
        
        const spherical = new THREE.Spherical();
        spherical.setFromVector3(camera3D.position);
        spherical.theta -= deltaX * 0.01;
        spherical.phi += deltaY * 0.01;
        spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
        camera3D.position.setFromSpherical(spherical);
        camera3D.lookAt(0, 0, 0);
        
        mouseX = e.clientX;
        mouseY = e.clientY;
      });
      
      container.addEventListener('mouseup', () => {
        mouseDown = false;
      });
      
      container.addEventListener('wheel', (e) => {
        if (!camera3D) return;
        const scale = e.deltaY > 0 ? 1.1 : 0.9;
        camera3D.position.multiplyScalar(scale);
        camera3D.position.clampLength(8000, 80000);
        e.preventDefault();
      });
    }
    
    let lastTime = 0;
    let frameCount = 0;
    
    function animate3D() {
      if (currentView !== 'globe' || !globe3D) {
        animationId = null;
        return;
      }
      
      animationId = requestAnimationFrame(animate3D);
      
      // FPS counter
      frameCount++;
      const currentTime = performance.now();
      if (currentTime >= lastTime + 1000) {
        const fps = document.getElementById('globe-fps');
        if (fps) fps.textContent = frameCount;
        frameCount = 0;
        lastTime = currentTime;
      }
      
      // Time display
      const timeEl = document.getElementById('globe-time');
      if (timeEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('pt-BR');
      }
      
      // Auto rotate
      if (autoRotate && earthMesh) {
        earthMesh.rotation.y += 0.002;
      }
      
      // Update satellites
      update3DSatellites();
      
      // Render
      if (renderer3D && scene3D && camera3D) {
        renderer3D.render(scene3D, camera3D);
      }
    }
    
    // ==================== CÁLCULOS DE SATÉLITE ====================
    
    function getSatState(rec, time = new Date()) {
      try {
        if (!rec) return null;
        
        const gmst = satellite.gstime(time);
        const pv = satellite.propagate(rec, time);
        
        if (!pv || !pv.position || pv.position === false) return null;
        
        const eci = pv.position;
        const vel = pv.velocity || {x: 0, y: 0, z: 0};
        const gd = satellite.eciToGeodetic(eci, gmst);
        
        const lat = satellite.radiansToDegrees(gd.latitude);
        const lon = satellite.radiansToDegrees(gd.longitude);
        const alt = gd.height;
        
        const speed = Math.sqrt(vel.x**2 + vel.y**2 + vel.z**2);
        
        // Calculate look angles from observer
        const obsGd = {
          latitude: satellite.degreesToRadians(obs.lat),
          longitude: satellite.degreesToRadians(obs.lon),
          height: 0
        };
        
        const satEcf = satellite.eciToEcf(eci, gmst);
        const look = satellite.ecfToLookAngles(obsGd, satEcf);
        
        const az = satellite.radiansToDegrees(look.azimuth);
        const el = satellite.radiansToDegrees(look.elevation);
        const range = look.rangeSat;
        
        return { lat, lon, alt, az, el, range, speed };
      } catch (err) {
        return null;
      }
    }
    
    function calculateLinkBudget(elevationDeg) {
      const FREQ = 11.5e9; // Hz (Ku-band downlink)
      const EIRP = 35; // dBW (satellite EIRP)
      const GAIN = 33; // dBi (user terminal gain)
      
      // Free space path loss calculation
      const distance = 550 / Math.sin(Math.max(elevationDeg, 1) * Math.PI / 180);
      const FSPL = 20 * Math.log10(distance * 1000) + 20 * Math.log10(FREQ) + 92.45;
      
      // Atmospheric losses (higher at low elevations)
      const atmosphericLoss = 0.5 / Math.sin(Math.max(elevationDeg, 5) * Math.PI / 180);
      
      const rxPower = EIRP - FSPL - atmosphericLoss + GAIN;
      
      return { rxPower, FSPL };
    }
    
    // ==================== ATUALIZAÇÃO DE SATÉLITES ====================
    
    function updateSatellites() {
      if (isDrawing) return;
      isDrawing = true;
      
      const startTime = performance.now();
      
      layerGroup.clearLayers();
      footprintGroup.clearLayers();
      
      let visible = 0;
      let drawn = 0;
      const MAX_DRAW = 1000;
      const step = Math.ceil(tleList.length / MAX_DRAW);
      
      for (let i = 0; i < tleList.length; i += step) {
        const t = tleList[i];
        const rec = satRecs[i];
        
        if (!rec) continue;
        
        const st = getSatState(rec);
        if (!st) continue;
        
        const isVisible = st.el >= obs.elevMin;
        const isSelected = selectedSatellite && selectedSatellite.index === i;
        
        // Tactical color scheme
        let color = '#004400'; // Dark green: not visible
        let radius = 2;
        let opacity = 0.3;
        
        if (isSelected) {
          color = '#ff00ff'; // Magenta: selected
          radius = 5;
          opacity = 0.9;
        } else if (isVisible) {
          color = '#00ff00'; // Bright green: visible
          radius = 3;
          opacity = 0.7;
          visible++;
        }
        
        const marker = L.circleMarker([st.lat, st.lon], {
          radius: radius,
          weight: 1,
          color: color,
          fillColor: color,
          fillOpacity: opacity,
          opacity: opacity + 0.2
        });
        
        const linkBudget = calculateLinkBudget(st.el);
        
        marker.bindPopup(`
          <div class="terminal-popup">
<strong>[${t.name || "SAT"}]</strong>
NORAD: ${t.noradId}
ALT..: ${st.alt.toFixed(0)} km
ELEV.: ${st.el.toFixed(1)}°
AZIM.: ${st.az.toFixed(1)}°
RANGE: ${(st.range/1000).toFixed(0)} km
SPEED: ${st.speed.toFixed(2)} km/s
FSPL.: ${linkBudget.FSPL.toFixed(1)} dB
          </div>
        `);
        
        marker.on('click', () => selectSatellite(i, t, rec, st));
        marker.addTo(layerGroup);
        drawn++;
        
        // Footprints
        if (config.showFootprints && isVisible && visible <= config.maxFootprints) {
          const footprintRadius = calculateFootprintRadius(st.alt, obs.elevMin);
          L.circle([st.lat, st.lon], {
            radius: footprintRadius * 1000,
            color: '#00ff00',
            weight: 2,
            opacity: 0.6,
            fillColor: '#00ff00',
            fillOpacity: 0.1,
            interactive: false,
            dashArray: '5,10'
          }).addTo(footprintGroup);
        }
      }
      
      const elapsed = performance.now() - startTime;
      
      // Update mission status
      document.getElementById("visibleInfo").innerHTML = `
        <div class="data-row">
          <span class="data-label">STATUS:</span>
          <span class="data-value good">OPERATIONAL</span>
        </div>
        <div class="data-row">
          <span class="data-label">RENDER:</span>
          <span class="data-value">${elapsed.toFixed(0)} ms</span>
        </div>
        <div class="data-row">
          <span class="data-label">LINK:</span>
          <span class="data-value good">ACTIVE</span>
        </div>
      `;
      
      updateStats(visible, drawn, satRecs.filter(r => r !== null).length);
      isDrawing = false;
    }
    
    function calculateFootprintRadius(altKm, elevMinDeg) {
      const Re = 6371; // Earth radius km
      const h = altKm;
      const e = elevMinDeg * Math.PI / 180;
      const psi = Math.acos((Re/(Re+h)) * Math.cos(e)) - e;
      return Re * psi;
    }
    
    function selectSatellite(index, t, rec, st) {
      selectedSatellite = { index, tle: t, rec, state: st };
      
      const linkBudget = calculateLinkBudget(st.el);
      
      // Update target overlay
      const targetInfo = document.getElementById('targetInfo');
      targetInfo.innerHTML = `
        <div class="data-row">
          <span class="data-label">SAT ID:</span>
          <span class="data-value">${t.name}</span>
        </div>
        <div class="data-row">
          <span class="data-label">ELEV:</span>
          <span class="data-value">${st.el.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">AZIM:</span>
          <span class="data-value">${st.az.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">RANGE:</span>
          <span class="data-value">${(st.range/1000).toFixed(0)} km</span>
        </div>
      `;
      
      // Update satellite info panel
      updateSatelliteInfo(index, st, linkBudget);
      updateRFAnalysis(st, linkBudget);
      updateOrbitalInfo(t, rec);
      
      updateTerminalLog('SELECT', `Satellite selected: ${t.name} [${t.noradId}]`);
      
      // Refresh map to update colors
      setTimeout(() => updateSatellites(), 100);
    }
    
    function updateSatelliteInfo(index, st, linkBudget) {
      const satInfo = document.getElementById('sat-info');
      const t = tleList[index];
      
      if (!t || !st) {
        updateTerminalLog('SAT', 'Invalid satellite selection');
        return;
      }
      
      const noradId = t.line1 ? t.line1.substring(2, 7) : t.noradId;
      
      satInfo.innerHTML = `
        <div class="sat-info-item">
          <span class="sat-info-label">NORAD</span>
          <span class="sat-info-value">${noradId}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">NAME</span>
          <span class="sat-info-value">${(t.name || "SAT").substring(0, 12)}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ALTITUDE</span>
          <span class="sat-info-value">${st.alt.toFixed(0)} km</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">VELOCITY</span>
          <span class="sat-info-value">${st.speed.toFixed(2)} km/s</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ELEVATION</span>
          <span class="sat-info-value">${st.el.toFixed(1)}°</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">AZIMUTH</span>
          <span class="sat-info-value">${st.az.toFixed(1)}°</span>
        </div>
      `;
    }
    
    function updateRFAnalysis(st, linkBudget) {
      document.getElementById('rf-power').textContent = `${linkBudget.rxPower.toFixed(1)} dBm`;
      document.getElementById('rf-fspl').textContent = `${linkBudget.FSPL.toFixed(1)} dB`;
      
      // Link status determination
      let status, statusClass;
      if (st.el < obs.elevMin) {
        status = 'BELOW HORIZON';
        statusClass = 'critical';
      } else if (linkBudget.rxPower > -80) {
        status = 'EXCELLENT';
        statusClass = 'good';
      } else if (linkBudget.rxPower > -90) {
        status = 'GOOD';
        statusClass = 'good';
      } else if (linkBudget.rxPower > -100) {
        status = 'MARGINAL';
        statusClass = 'warning';
      } else {
        status = 'POOR';
        statusClass = 'critical';
      }
      
      const statusEl = document.getElementById('rf-status');
      statusEl.textContent = status;
      statusEl.className = `data-value ${statusClass}`;
    }
    
    function updateOrbitalInfo(t, rec) {
      const orbitalInfo = document.getElementById('orbital-info');
      
      if (!t || !rec) return;
      
      // Extract orbital elements from TLE
      const line1 = t.line1;
      const line2 = t.line2;
      
      if (!line1 || !line2) return;
      
      const inclination = parseFloat(line2.substring(8, 16));
      const raan = parseFloat(line2.substring(17, 25));
      const eccentricity = parseFloat('0.' + line2.substring(26, 33));
      const argPerigee = parseFloat(line2.substring(34, 42));
      const meanAnomaly = parseFloat(line2.substring(43, 51));
      const meanMotion = parseFloat(line2.substring(52, 63));
      
      const period = 1440 / meanMotion; // minutes
      
      orbitalInfo.innerHTML = `
        <div class="terminal-text">
┌─ ORBITAL ELEMENTS ─┐
│ INCL......: ${inclination.toFixed(2)}°        │
│ RAAN......: ${raan.toFixed(2)}°        │
│ ECC.......: ${eccentricity.toFixed(6)}     │
│ ARG_PER...: ${argPerigee.toFixed(2)}°        │
│ MEAN_ANOM.: ${meanAnomaly.toFixed(2)}°        │
│ MEAN_MOT..: ${meanMotion.toFixed(5)} rev/day │
│ PERIOD....: ${period.toFixed(1)} min       │
└──────────────────────┘
        </div>
      `;
    }
    
    // ==================== CONTROLES ====================
    
    function switchView(view) {
      currentView = view;
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      document.querySelectorAll('.view-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(view + '-view').classList.add('active');
      
      if (view === 'globe' && !globe3D) {
        setTimeout(() => init3DGlobe(), 100);
      }
      
      if (view === 'globe' && globe3D) {
        animate3D();
      }
      
      updateTerminalLog('VIEW', `Display mode: ${view.toUpperCase()}`);
    }
    
    function resetGlobeView() {
      if (camera3D) {
        camera3D.position.set(15000, 10000, 15000);
        camera3D.lookAt(0, 0, 0);
      }
      if (earthMesh) {
        earthMesh.rotation.set(0, 0, 0);
      }
      updateTerminalLog('3D', 'Tactical view reset');
    }
    
    function toggleRotation() {
      autoRotate = !autoRotate;
      const rotEl = document.getElementById('globe-rotation');
      if (rotEl) rotEl.textContent = autoRotate ? 'ON' : 'OFF';
      updateTerminalLog('3D', `Auto-rotation ${autoRotate ? 'enabled' : 'disabled'}`);
    }
    
    // ==================== UTILITÁRIOS ====================
    
    function updateTerminalLog(type, message) {
      const time = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
      
      const terminal = document.getElementById('terminalOutput');
      if (terminal) {
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.innerHTML = `<span class="time">[${time}]</span> <span class="type">[${type}]</span> <span class="message">${message}</span>`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
        
        while (terminal.children.length > 50) {
          terminal.removeChild(terminal.firstChild);
        }
      }
      
      console.log(`%c[${time}] [${type}] ${message}`, "color: #00ff00; font-family: monospace");
    }
    
    function updateStats(visible, tracked, total) {
      document.getElementById('stat-visible').textContent = visible || 0;
      document.getElementById('stat-tracked').textContent = tracked || 0;
      document.getElementById('stat-total').textContent = total || 0;
    }
    
    // ==================== EVENT LISTENERS ====================
    
    window.addEventListener('resize', () => {
      if (renderer3D && camera3D) {
        const container = document.getElementById('globe');
        if (container) {
          camera3D.aspect = container.clientWidth / container.clientHeight;
          camera3D.updateProjectionMatrix();
          renderer3D.setSize(container.clientWidth, container.clientHeight);
        }
      }
    });
    
    // Export functions
    window.switchView = switchView;
    window.resetGlobeView = resetGlobeView;
    window.toggleRotation = toggleRotation;
    
    // ==================== INICIALIZAÇÃO ====================
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
