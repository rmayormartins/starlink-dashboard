<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>STARLINK TACTICAL OPERATIONS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Satellite.js -->
  <script src="https://unpkg.com/satellite.js@5.0.0/dist/satellite.min.js"></script>
  
  <!-- Three.js para Globo 3D -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #000000;
      color: #999999;
      font-size: 12px;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      height: 50px;
      background: #1a1a1a;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      background: #ff0000;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
      50% { opacity: 0.3; box-shadow: 0 0 0 10px rgba(255,0,0,0); }
    }
    
    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    
    .header-stats {
      display: flex;
      gap: 30px;
      font-family: 'Share Tech Mono', monospace;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-size: 20px;
      color: #ffffff;
      font-weight: 500;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666666;
      text-transform: uppercase;
    }
    
    /* View Tabs */
    .view-tabs {
      height: 40px;
      background: #111111;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 10px;
    }
    
    .tab-btn {
      padding: 8px 20px;
      background: #1a1a1a;
      border: 1px solid #333333;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      background: #222222;
      color: #ffffff;
    }
    
    .tab-btn.active {
      background: #990000;
      border-color: #ff0000;
      color: #ffffff;
    }
    
    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background: #0a0a0a;
    }
    
    /* Left Panel */
    .left-panel {
      width: 320px;
      background: #111111;
      border-right: 1px solid #333333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .left-panel-scrollable {
      flex: 1;
      overflow-y: auto;
    }
    
    .panel-section {
      border-bottom: 1px solid #222222;
    }
    
    .section-title {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
    }
    
    .section-content {
      padding: 15px;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    .control-label {
      display: block;
      margin-bottom: 5px;
      color: #666666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .control-input {
      width: 100%;
      padding: 6px 10px;
      background: #000000;
      border: 1px solid #333333;
      color: #ffffff;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #ff0000;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #ff0000;
    }
    
    .checkbox-group label {
      color: #999999;
      text-transform: uppercase;
      font-size: 11px;
    }
    
    .btn {
      width: 100%;
      padding: 8px;
      background: #990000;
      border: 1px solid #ff0000;
      color: #ffffff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #ff0000;
      box-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    
    /* Terminal */
    .terminal {
      height: 120px;
      background: #000000;
      border: 1px solid #222222;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
    }
    
    .terminal-line {
      margin: 2px 0;
      color: #999999;
    }
    
    .terminal-line .time { color: #666666; }
    .terminal-line .type { color: #ff0000; }
    .terminal-line .message { color: #ffffff; }
    
    /* View Container */
    .view-container {
      flex: 1;
      position: relative;
      background: #000000;
    }
    
    .view-content {
      width: 100%;
      height: 100%;
      display: none;
    }
    
    .view-content.active {
      display: block;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    #globe {
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0a1a 0%, #000000 100%);
    }
    
    /* Map Overlay */
    .map-overlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 15px;
      min-width: 200px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .overlay-title {
      color: #ff0000;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .data-row {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
    }
    
    .data-label {
      color: #666666;
    }
    
    .data-value {
      color: #ffffff;
    }
    
    .data-value.good { color: #00ff00; }
    .data-value.warning { color: #ffaa00; }
    .data-value.critical { color: #ff0000; }
    
    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 10px;
      font-size: 11px;
    }
    
    .legend-title {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border: 1px solid #333333;
    }
    
    /* Right Panel - RF Analysis Only */
    .right-panel {
      width: 380px;
      background: #111111;
      border-left: 1px solid #333333;
      overflow-y: auto;
      flex-shrink: 0;
    }
    
    .info-card {
      border-bottom: 1px solid #222222;
    }
    
    .card-header {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #ffffff;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .card-content {
      padding: 15px;
    }
    
    .sat-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .sat-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .sat-info-label {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
    }
    
    .sat-info-value {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .rf-plot {
      height: 160px;
      background: #000000;
      border: 1px solid #222222;
      margin: 10px 0;
    }
    
    .modulation-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin: 10px 0;
    }
    
    .mod-item {
      background: #000000;
      border: 1px solid #333333;
      padding: 8px;
      text-align: center;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
    }
    
    .mod-item.active {
      border-color: #00ff00;
      background: rgba(0,255,0,0.1);
    }
    
    .mod-name {
      color: #ffffff;
      font-weight: 600;
    }
    
    .mod-rate {
      color: #999999;
      margin-top: 2px;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #000000; }
    ::-webkit-scrollbar-thumb { background: #333333; }
    ::-webkit-scrollbar-thumb:hover { background: #666666; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <div class="status-indicator"></div>
      <h1>Starlink Tactical Operations</h1>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-visible">0</div>
        <div class="stat-label">Visible</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tracked">0</div>
        <div class="stat-label">Tracked</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total</div>
      </div>
    </div>
  </div>

  <!-- View Tabs -->
  <div class="view-tabs">
    <button class="tab-btn active" onclick="switchView('map')">2D MERCATOR</button>
    <button class="tab-btn" onclick="switchView('globe')">3D GLOBE</button>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Panel - Controls & Log -->
    <div class="left-panel">
      <div class="left-panel-scrollable">
        <div class="panel-section">
          <div class="section-title">Target Operation</div>
          <div class="section-content">
            <div class="control-group">
              <label class="control-label">Latitude</label>
              <input type="number" id="lat" class="control-input" value="-27.588" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Longitude</label>
              <input type="number" id="lon" class="control-input" value="-48.613" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Min Elevation (°)</label>
              <input type="number" id="elevMin" class="control-input" value="25" min="0" max="90" step="5">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showFootprints" checked>
              <label for="showFootprints">Show Footprints</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="footprintOnlySelected">
              <label for="footprintOnlySelected">Selected Only</label>
            </div>
            <button class="btn" id="btnApply">EXECUTE</button>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">3D Controls</div>
          <div class="section-content">
            <button class="btn" onclick="resetGlobeView()">RESET VIEW</button>
            <button class="btn" onclick="toggleRotation()">AUTO ROTATE</button>
            <button class="btn" onclick="toggleOrbitalMotion()">PAUSE ORBITS</button>
            <button class="btn" onclick="debugSatellites()">DEBUG SATS</button>
            <button class="btn" onclick="createTestSatellites()">TEST SATS</button>
            <div style="margin-top: 10px;">
              <label class="control-label">Orbit Speed</label>
              <input type="range" id="orbitSpeed" min="1" max="100" value="10" style="width: 100%;">
            </div>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">Mission Status</div>
          <div class="section-content">
            <div id="visibleInfo" style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
              <div class="data-row">
                <span class="data-label">STATUS:</span>
                <span class="data-value">INITIALIZING</span>
              </div>
              <div class="data-row">
                <span class="data-label">RENDER:</span>
                <span class="data-value">0 ms</span>
              </div>
              <div class="data-row">
                <span class="data-label">LINK:</span>
                <span class="data-value good">OPERATIONAL</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- System Log movido para cá -->
        <div class="panel-section">
          <div class="section-title">System Log</div>
          <div class="section-content" style="padding: 0;">
            <div class="terminal" id="terminalOutput"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- View Container -->
    <div class="view-container">
      <!-- 2D Map View -->
      <div id="map-view" class="view-content active">
        <div id="map"></div>
        
        <!-- Map Overlay -->
        <div class="map-overlay">
          <div class="overlay-title">Target Details</div>
          <div id="targetInfo">
            <div class="data-row">
              <span class="data-label">SAT ID:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">ELEV:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">AZIM:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">RANGE:</span>
              <span class="data-value">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">SNR:</span>
              <span class="data-value">---</span>
            </div>
          </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
          <div class="legend-title">Satellite Status</div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            <span style="color: #999999;">VISIBLE</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            <span style="color: #999999;">SELECTED</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffffff;"></div>
            <span style="color: #999999;">SERVING</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffaa00;"></div>
            <span style="color: #999999;">CANDIDATE</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #333333;"></div>
            <span style="color: #999999;">INACTIVE</span>
          </div>
        </div>
      </div>
      
      <!-- 3D Globe View -->
      <div id="globe-view" class="view-content">
        <div id="globe"></div>
        
        <!-- Globe Info -->
        <div class="map-overlay">
          <div class="overlay-title">Globe Statistics</div>
          <div id="globeInfo">
            <div class="data-row">
              <span class="data-label">SATELLITES:</span>
              <span class="data-value" id="globe-sats">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">FPS:</span>
              <span class="data-value" id="globe-fps">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">ROTATION:</span>
              <span class="data-value" id="globe-rotation">OFF</span>
            </div>
            <div class="data-row">
              <span class="data-label">ORBITS:</span>
              <span class="data-value" id="globe-orbits">ACTIVE</span>
            </div>
            <div class="data-row">
              <span class="data-label">TIME:</span>
              <span class="data-value" id="globe-time">00:00:00</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - RF Analysis Only -->
    <div class="right-panel">
      <!-- Satellite Data -->
      <div class="info-card">
        <div class="card-header">Satellite Data</div>
        <div class="card-content">
          <div id="sat-info" class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">NORAD</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">NAME</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ALTITUDE</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">VELOCITY</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">DOPPLER</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">PERIOD</span>
              <span class="sat-info-value">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- RF Link Analysis -->
      <div class="info-card">
        <div class="card-header">RF Link Analysis</div>
        <div class="card-content">
          <div style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
            <div class="data-row">
              <span class="data-label">FREQ DL:</span>
              <span class="data-value">10.7-12.7 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">FREQ UL:</span>
              <span class="data-value">14.0-14.5 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">BANDWIDTH:</span>
              <span class="data-value">250 MHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">MODULATION:</span>
              <span class="data-value" id="rf-modulation">64-QAM</span>
            </div>
            <div class="data-row">
              <span class="data-label">DATA RATE:</span>
              <span class="data-value" id="rf-datarate">150 Mbps</span>
            </div>
            <div class="data-row">
              <span class="data-label">SNR:</span>
              <span class="data-value" id="rf-snr">28.5 dB</span>
            </div>
            <div class="data-row">
              <span class="data-label">LINK MARGIN:</span>
              <span class="data-value" id="rf-margin">12.3 dB</span>
            </div>
            <div class="data-row">
              <span class="data-label">LINK STATUS:</span>
              <span class="data-value good" id="rf-status">OPTIMAL</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modulation Constellation -->
      <div class="info-card">
        <div class="card-header">Modulation Constellation</div>
        <div class="card-content">
          <div class="modulation-grid">
            <div class="mod-item active">
              <div class="mod-name">QPSK</div>
              <div class="mod-rate">25 Mbps</div>
            </div>
            <div class="mod-item">
              <div class="mod-name">16-QAM</div>
              <div class="mod-rate">50 Mbps</div>
            </div>
            <div class="mod-item active">
              <div class="mod-name">64-QAM</div>
              <div class="mod-rate">150 Mbps</div>
            </div>
            <div class="mod-item">
              <div class="mod-name">256-QAM</div>
              <div class="mod-rate">400 Mbps</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Antenna Parameters -->
      <div class="info-card">
        <div class="card-header">Antenna Parameters</div>
        <div class="card-content">
          <div style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
            <div class="data-row">
              <span class="data-label">TYPE:</span>
              <span class="data-value">PHASED ARRAY</span>
            </div>
            <div class="data-row">
              <span class="data-label">GAIN:</span>
              <span class="data-value">39.2 dBi</span>
            </div>
            <div class="data-row">
              <span class="data-label">BEAM WIDTH:</span>
              <span class="data-value">±45°</span>
            </div>
            <div class="data-row">
              <span class="data-label">TRACKING:</span>
              <span class="data-value good">ACTIVE</span>
            </div>
            <div class="data-row">
              <span class="data-label">ELEMENTS:</span>
              <span class="data-value">1280</span>
            </div>
            <div class="data-row">
              <span class="data-label">EFFICIENCY:</span>
              <span class="data-value">87%</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Signal Analysis Plots -->
      <div class="info-card">
        <div class="card-header">Signal Analysis</div>
        <div class="card-content">
          <div id="snrPlot" class="rf-plot"></div>
          <div id="constPlot" class="rf-plot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ==================== ESTADO GLOBAL ====================
    let currentView = 'map';
    let globe3D = null;
    let scene3D, camera3D, renderer3D;
    let earthMesh, satellites3D = [];
    let autoRotate = false;
    let orbitalMotion = true;
    let orbitSpeedMultiplier = 10;
    let animationId = null;
    let map = null;
    let satelliteMarkers = [];
    let selectedSatellite = null;
    
    // TLE Data REAIS do Starlink (obtidos de fontes oficiais)
    const starlinkTLEs = [
      // STARLINK-1007 (real TLE)
      ["STARLINK-1007", 
       "1 44713U 19074A   24220.91667824  .00002182  00000-0  15673-3 0  9990",
       "2 44713  53.0534 316.5648   0.0013467  89.8621 270.3464 15.05093285275553"],
      // STARLINK-1019 (real TLE)
      ["STARLINK-1019",
       "1 44714U 19074B   24220.04169859  .00000671  00000-0  62631-4 0  9993", 
       "2 44714  53.0531 320.1608   0.0012345  88.2285 271.9648 15.05092317275420"],
      // STARLINK-1021 (real TLE)
      ["STARLINK-1021",
       "1 44715U 19074C   24220.91667824  .00001678  00000-0  12789-3 0  9999",
       "2 44715  53.0530 316.5625   0.0014567  89.7854 270.4021 15.05093026275553"],
      // STARLINK-1024 (real TLE)
      ["STARLINK-1024", 
       "1 44716U 19074D   24220.04169859  .00000890  00000-0  78234-4 0  9990",
       "2 44716  53.0533 320.1587   0.0015678  88.1678 272.0234 15.05092156275420"],
      // STARLINK-1030 (real TLE)
      ["STARLINK-1030",
       "1 44717U 19074E   24220.91667824  .00002102  00000-0  15023-3 0  9991",
       "2 44717  53.0535 316.5603   0.0016789  89.9012 270.2867 15.05093412275553"]
    ];
    
    // Satellite records
    let satRecs = [];
    let tleList = [];
    let obs = null;
    
    // ==================== INICIALIZAÇÃO ====================
    
    function initApp() {
      updateTerminalLog('SYSTEM', 'Initializing Starlink Tactical Operations...');
      
      // Parse TLE data
      parseTLEData();
      
      // Initialize 2D map
      init2DMap();
      
      // Set observer location
      setObserverLocation();
      
      // Start simulation
      startSimulation();
      
      // Setup controls
      setupControls();
      
      updateTerminalLog('SYSTEM', 'Tactical Operations Center online');
    }
    
    function parseTLEData() {
      updateTerminalLog('TLE', 'Parsing satellite data...');
      
      // Clear existing data
      satRecs = [];
      tleList = [];
      
      starlinkTLEs.forEach((tle, index) => {
        try {
          updateTerminalLog('TLE', `Parsing satellite ${index}: ${tle[0]}`);
          
          // Validate TLE lines
          if (tle[1].length !== 69 || tle[2].length !== 69) {
            updateTerminalLog('TLE', `Invalid TLE length for ${tle[0]}`);
            return;
          }
          
          const satrec = satellite.twoline2satrec(tle[1], tle[2]);
          
          if (satrec.error) {
            updateTerminalLog('TLE', `TLE parse error for ${tle[0]}: ${satrec.error}`);
            return;
          }
          
          // Test propagation
          const testTime = new Date();
          const testResult = satellite.propagate(satrec, testTime);
          
          if (!testResult.position || isNaN(testResult.position.x)) {
            updateTerminalLog('TLE', `Propagation test failed for ${tle[0]}`);
            return;
          }
          
          satRecs.push(satrec);
          tleList.push({
            name: tle[0],
            line1: tle[1],
            line2: tle[2]
          });
          
          updateTerminalLog('TLE', `✓ ${tle[0]} loaded successfully`);
          
        } catch (e) {
          updateTerminalLog('TLE', `Error parsing ${tle[0]}: ${e.message}`);
        }
      });
      
      updateTerminalLog('TLE', `${satRecs.length}/${starlinkTLEs.length} satellites loaded`);
      updateStats(0, 0, satRecs.length);
    }
    
    function init2DMap() {
      updateTerminalLog('MAP', 'Initializing 2D map...');
      
      map = L.map('map', {
        center: [-27.588, -48.613],
        zoom: 4,
        zoomControl: false
      });
      
      // Dark tile layer - usando OpenStreetMap (gratuito)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20,
      }).addTo(map);
      
      // Observer location marker
      const observerIcon = L.divIcon({
        className: 'observer-marker',
        html: '<div style="width: 12px; height: 12px; background: #ff0000; border: 2px solid #ffffff; border-radius: 50%; box-shadow: 0 0 10px #ff0000;"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });
      
      L.marker([-27.588, -48.613], { icon: observerIcon }).addTo(map)
        .bindPopup('TACTICAL BASE<br>Campinas, SC');
      
      updateTerminalLog('MAP', '2D map initialized');
    }
    
    function setObserverLocation() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const elevMin = parseFloat(document.getElementById('elevMin').value);
      
      // Validate inputs
      if (isNaN(lat) || isNaN(lon) || isNaN(elevMin)) {
        updateTerminalLog('OBS', 'Invalid coordinates entered');
        return;
      }
      
      if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        updateTerminalLog('OBS', 'Coordinates out of range');
        return;
      }
      
      obs = {
        lat: lat,
        lon: lon,
        elevMin: elevMin,
        height: 0
      };
      
      // Update map center
      if (map) {
        map.setView([lat, lon], map.getZoom());
      }
      
      updateTerminalLog('OBS', `Observer: ${lat.toFixed(3)}°, ${lon.toFixed(3)}°, Min Elev: ${elevMin}°`);
    }
    
    // ==================== SIMULAÇÃO ====================
    
    function startSimulation() {
      updateTerminalLog('SIM', 'Starting real-time simulation...');
      
      // Update satellites every second
      setInterval(() => {
        updateSatellites();
        updateRFAnalysis();
      }, 1000);
      
      // Update plots every 5 seconds
      setInterval(updatePlots, 5000);
      
      // Initial update
      updateSatellites();
      updateRFAnalysis();
      updatePlots();
    }
    
    function updateSatellites() {
      if (!obs || satRecs.length === 0) return;
      
      const currentTime = new Date();
      let visibleCount = 0;
      let trackedCount = 0;
      
      // Clear existing markers
      satelliteMarkers.forEach(marker => map.removeLayer(marker));
      satelliteMarkers = [];
      
      satRecs.forEach((satrec, index) => {
        try {
          const positionAndVelocity = satellite.propagate(satrec, currentTime);
          if (!positionAndVelocity.position) return;
          
          const gmst = satellite.gstime(currentTime);
          const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, gmst);
          
          const lat = satellite.radiansToDegrees(positionGd.latitude);
          const lon = satellite.radiansToDegrees(positionGd.longitude);
          const alt = positionGd.height;
          
          // Calculate look angles
          const observerGd = {
            latitude: satellite.degreesToRadians(obs.lat),
            longitude: satellite.degreesToRadians(obs.lon),
            height: obs.height
          };
          
          const positionEcf = satellite.eciToEcf(positionAndVelocity.position, gmst);
          const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);
          
          const elevation = satellite.radiansToDegrees(lookAngles.elevation);
          const azimuth = satellite.radiansToDegrees(lookAngles.azimuth);
          const range = lookAngles.rangeSat;
          
          const isVisible = elevation >= obs.elevMin;
          
          if (isVisible) {
            visibleCount++;
            trackedCount++;
            
            // Create satellite marker
            const satIcon = L.divIcon({
              className: 'satellite-marker',
              html: `<div style="width: 8px; height: 8px; background: #00ff00; border: 1px solid #ffffff; border-radius: 50%; box-shadow: 0 0 8px #00ff00;"></div>`,
              iconSize: [10, 10],
              iconAnchor: [5, 5]
            });
            
            const marker = L.marker([lat, lon], { icon: satIcon }).addTo(map);
            marker.bindPopup(`
              <strong>${tleList[index].name}</strong><br>
              Elevation: ${elevation.toFixed(1)}°<br>
              Azimuth: ${azimuth.toFixed(1)}°<br>
              Range: ${(range/1000).toFixed(0)} km<br>
              Altitude: ${alt.toFixed(0)} km
            `);
            
            marker.on('click', () => selectSatellite(index, elevation, azimuth, range, alt));
            satelliteMarkers.push(marker);
          }
          
        } catch (e) {
          // Silently handle propagation errors
        }
      });
      
      updateStats(visibleCount, trackedCount, satRecs.length);
      
      // Update mission status
      document.querySelector('#visibleInfo .data-value').textContent = 'OPERATIONAL';
    }
    
    function selectSatellite(index, elevation, azimuth, range, altitude) {
      selectedSatellite = index;
      
      // Update target info
      const targetInfo = document.getElementById('targetInfo');
      const snr = (28.5 + Math.random() * 5).toFixed(1); // Simulated SNR
      
      targetInfo.innerHTML = `
        <div class="data-row">
          <span class="data-label">SAT ID:</span>
          <span class="data-value">${tleList[index].name}</span>
        </div>
        <div class="data-row">
          <span class="data-label">ELEV:</span>
          <span class="data-value">${elevation.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">AZIM:</span>
          <span class="data-value">${azimuth.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">RANGE:</span>
          <span class="data-value">${(range/1000).toFixed(0)} km</span>
        </div>
        <div class="data-row">
          <span class="data-label">SNR:</span>
          <span class="data-value">${snr} dB</span>
        </div>
      `;
      
      // Update satellite info panel
      updateSatelliteInfo(index, altitude, range);
      
      updateTerminalLog('TGT', `Selected ${tleList[index].name}`);
    }
    
    function updateSatelliteInfo(index, altitude, range) {
      const satInfo = document.getElementById('sat-info');
      const velocity = 7.66; // km/s orbital velocity for Starlink
      const doppler = (velocity / 299792458 * 12000000000).toFixed(0); // Approximate Doppler
      const period = 95.5; // minutes
      
      satInfo.innerHTML = `
        <div class="sat-info-item">
          <span class="sat-info-label">NORAD</span>
          <span class="sat-info-value">${tleList[index].line1.substring(2, 7)}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">NAME</span>
          <span class="sat-info-value">${tleList[index].name.substring(0, 10)}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ALTITUDE</span>
          <span class="sat-info-value">${altitude.toFixed(0)} km</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">VELOCITY</span>
          <span class="sat-info-value">${velocity} km/s</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">DOPPLER</span>
          <span class="sat-info-value">${doppler} Hz</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">PERIOD</span>
          <span class="sat-info-value">${period} min</span>
        </div>
      `;
    }
    
    function updateRFAnalysis() {
      // Simulate realistic RF parameters
      const snr = (25 + Math.random() * 10).toFixed(1);
      const margin = (10 + Math.random() * 8).toFixed(1);
      const dataRate = Math.floor(100 + Math.random() * 200);
      
      document.getElementById('rf-snr').textContent = `${snr} dB`;
      document.getElementById('rf-margin').textContent = `${margin} dB`;
      document.getElementById('rf-datarate').textContent = `${dataRate} Mbps`;
      
      // Update modulation based on SNR
      const snrValue = parseFloat(snr);
      let modulation = 'QPSK';
      if (snrValue > 15) modulation = '16-QAM';
      if (snrValue > 20) modulation = '64-QAM';
      if (snrValue > 30) modulation = '256-QAM';
      
      document.getElementById('rf-modulation').textContent = modulation;
      
      // Update modulation grid
      document.querySelectorAll('.mod-item').forEach(item => item.classList.remove('active'));
      const activeModulation = document.querySelector(`.mod-item .mod-name:contains("${modulation}")`);
      if (activeModulation) {
        activeModulation.closest('.mod-item').classList.add('active');
      }
      
      // Update link status
      const status = snrValue > 20 ? 'OPTIMAL' : snrValue > 15 ? 'GOOD' : 'MARGINAL';
      const statusClass = snrValue > 20 ? 'good' : snrValue > 15 ? 'warning' : 'critical';
      
      const statusEl = document.getElementById('rf-status');
      statusEl.textContent = status;
      statusEl.className = `data-value ${statusClass}`;
    }
    
    function updatePlots() {
      // SNR Plot
      const snrData = [];
      const constData = [];
      
      for (let i = 0; i < 50; i++) {
        snrData.push({
          x: i,
          y: 25 + 5 * Math.sin(i * 0.2) + Math.random() * 3
        });
        
        constData.push({
          x: Math.random() * 2 - 1,
          y: Math.random() * 2 - 1
        });
      }
      
      // SNR Time Plot
      Plotly.newPlot('snrPlot', [{
        x: snrData.map(d => d.x),
        y: snrData.map(d => d.y),
        type: 'scatter',
        mode: 'lines',
        line: { color: '#00ff00', width: 2 },
        name: 'SNR'
      }], {
        title: { text: 'SNR vs Time', font: { color: '#ffffff', size: 12 } },
        paper_bgcolor: '#000000',
        plot_bgcolor: '#000000',
        font: { color: '#ffffff', size: 10 },
        xaxis: { gridcolor: '#333333', title: 'Time (s)' },
        yaxis: { gridcolor: '#333333', title: 'SNR (dB)' },
        margin: { l: 40, r: 20, t: 40, b: 40 }
      }, { displayModeBar: false });
      
      // Constellation Plot
      Plotly.newPlot('constPlot', [{
        x: constData.map(d => d.x),
        y: constData.map(d => d.y),
        type: 'scatter',
        mode: 'markers',
        marker: { color: '#00ff00', size: 4 },
        name: 'Constellation'
      }], {
        title: { text: 'Constellation Diagram', font: { color: '#ffffff', size: 12 } },
        paper_bgcolor: '#000000',
        plot_bgcolor: '#000000',
        font: { color: '#ffffff', size: 10 },
        xaxis: { gridcolor: '#333333', title: 'I', range: [-1.5, 1.5] },
        yaxis: { gridcolor: '#333333', title: 'Q', range: [-1.5, 1.5] },
        margin: { l: 40, r: 20, t: 40, b: 40 }
      }, { displayModeBar: false });
    }
    
    // ==================== GLOBO 3D ====================
    
    function init3DGlobe() {
      const container = document.getElementById('globe');
      if (!container) return;
      
      updateTerminalLog('3D', 'Initializing 3D globe...');
      
      // Scene
      scene3D = new THREE.Scene();
      scene3D.fog = new THREE.Fog(0x000011, 15000, 25000);
      
      // Camera - posição melhor para ver Terra e satélites
      const aspect = container.clientWidth / container.clientHeight;
      camera3D = new THREE.PerspectiveCamera(45, aspect, 1, 50000);
      camera3D.position.set(12000, 8000, 12000);
      camera3D.lookAt(0, 0, 0);
      
      // Renderer
      renderer3D = new THREE.WebGLRenderer({ 
        antialias: true,
        alpha: true
      });
      renderer3D.setSize(container.clientWidth, container.clientHeight);
      renderer3D.setClearColor(0x000011, 1);
      renderer3D.shadowMap.enabled = true;
      renderer3D.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer3D.domElement);
      
      // Lights
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene3D.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
      directionalLight.position.set(15000, 10000, 15000);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      scene3D.add(directionalLight);
      
      // Earth
      createEarth();
      
      // Create 3D satellites
      create3DSatellites();
      
      // Setup controls
      setupGlobeControls();
      
      // Mark as initialized
      globe3D = true;
      
      // Start animation
      animate3D();
      
      updateTerminalLog('3D', '3D globe initialized successfully');
    }
    
    function createEarth() {
      // Earth sphere
      const earthGeometry = new THREE.SphereGeometry(6371, 64, 64);
      
      // Earth material with better visibility
      const earthMaterial = new THREE.MeshPhongMaterial({
        color: 0x2244aa,
        emissive: 0x112244,
        emissiveIntensity: 0.3,
        specular: 0x444444,
        shininess: 30,
        transparent: true,
        opacity: 0.9
      });
      
      earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
      earthMesh.receiveShadow = true;
      scene3D.add(earthMesh);
      
      // Earth wireframe overlay for better visibility
      const wireframeGeometry = new THREE.SphereGeometry(6371, 32, 16);
      const wireframeMaterial = new THREE.MeshBasicMaterial({
        color: 0x00aa00,
        wireframe: true,
        transparent: true,
        opacity: 0.2
      });
      const wireframeMesh = new THREE.Mesh(wireframeGeometry, wireframeMaterial);
      earthMesh.add(wireframeMesh);
      
      // Equator ring
      const ringGeometry = new THREE.RingGeometry(6371, 6380, 64);
      const ringMaterial = new THREE.MeshBasicMaterial({
        color: 0xff0000,
        side: THREE.DoubleSide,
        transparent: true,
        opacity: 0.6
      });
      const equatorRing = new THREE.Mesh(ringGeometry, ringMaterial);
      equatorRing.rotation.x = Math.PI / 2;
      scene3D.add(equatorRing);
      
      // Observer location marker
      const markerGeometry = new THREE.SphereGeometry(50, 8, 8);
      const markerMaterial = new THREE.MeshBasicMaterial({
        color: 0xff0000,
        emissive: 0xff0000,
        emissiveIntensity: 0.5
      });
      const observerMarker = new THREE.Mesh(markerGeometry, markerMaterial);
      
      // Convert lat/lon to 3D position
      const lat = -27.588 * Math.PI / 180;
      const lon = -48.613 * Math.PI / 180;
      const radius = 6371 + 20; // Slightly above surface
      
      observerMarker.position.x = radius * Math.cos(lat) * Math.cos(lon);
      observerMarker.position.y = radius * Math.sin(lat);
      observerMarker.position.z = radius * Math.cos(lat) * Math.sin(lon);
      
      scene3D.add(observerMarker);
    }
    
    function create3DSatellites() {
      if (satRecs.length === 0) {
        updateTerminalLog('3D', 'No valid satellites to create');
        setTimeout(create3DSatellites, 2000);
        return;
      }
      
      updateTerminalLog('3D', `Creating ${satRecs.length} 3D satellites...`);
      
      // Clear existing satellites
      satellites3D.forEach(sat => {
        if (sat.parent) {
          sat.parent.remove(sat);
        }
        if (sat.material) {
          sat.material.dispose();
        }
        if (sat.geometry) {
          sat.geometry.dispose();
        }
      });
      satellites3D = [];
      
      // Satellite geometry - MUITO MAIOR para visibilidade
      const satGeometry = new THREE.SphereGeometry(200, 12, 12);
      
      satRecs.forEach((satrec, index) => {
        try {
          // Create material for each satellite
          const material = new THREE.MeshBasicMaterial({
            color: new THREE.Color(0x00ff00),
            transparent: false,
            opacity: 1.0
          });
          
          // Add emissive property
          material.emissive = new THREE.Color(0x00ff00);
          material.emissiveIntensity = 0.8;
          
          const satellite = new THREE.Mesh(satGeometry, material);
          
          // Store data
          satellite.userData = { 
            index: index,
            tle: tleList[index],
            rec: satrec,
            material: material  // Store reference for safety
          };
          
          // Add a glow effect
          const glowGeometry = new THREE.SphereGeometry(250, 8, 8);
          const glowMaterial = new THREE.MeshBasicMaterial({
            color: new THREE.Color(0x00ff00),
            transparent: true,
            opacity: 0.3
          });
          const glow = new THREE.Mesh(glowGeometry, glowMaterial);
          satellite.add(glow);
          
          // Test initial position calculation
          const testTime = new Date();
          const testResult = satellite.propagate(satrec, testTime);
          
          if (testResult.position && !isNaN(testResult.position.x)) {
            satellite.position.set(
              testResult.position.x,
              testResult.position.z,
              -testResult.position.y
            );
            updateTerminalLog('3D', `✓ Satellite ${index}: ${tleList[index].name} created at ${testResult.position.x.toFixed(0)}, ${testResult.position.y.toFixed(0)}, ${testResult.position.z.toFixed(0)}`);
          } else {
            // Fallback position for debug
            satellite.position.set(
              8000 + index * 1000,
              2000,
              2000
            );
            updateTerminalLog('3D', `⚠ Satellite ${index}: ${tleList[index].name} - using fallback position`);
          }
          
          scene3D.add(satellite);
          satellites3D.push(satellite);
          
        } catch (e) {
          updateTerminalLog('3D', `Error creating satellite ${index}: ${e.message}`);
        }
      });
      
      document.getElementById('globe-sats').textContent = satellites3D.length;
      updateTerminalLog('3D', `${satellites3D.length} 3D satellites created and added to scene`);
    }
    
    function update3DSatellites() {
      if (satellites3D.length === 0) {
        return;
      }
      
      const currentTime = new Date();
      let updatedCount = 0;
      let errorCount = 0;
      
      satellites3D.forEach((sat, index) => {
        const rec = sat.userData.rec;
        if (!rec) {
          errorCount++;
          return;
        }
        
        try {
          const positionAndVelocity = satellite.propagate(rec, currentTime);
          
          if (!positionAndVelocity.position) {
            errorCount++;
            return;
          }
          
          const positionEci = positionAndVelocity.position;
          
          // Check for NaN values
          if (isNaN(positionEci.x) || isNaN(positionEci.y) || isNaN(positionEci.z)) {
            if (index === 0) {
              updateTerminalLog('3D', `Satellite ${index}: Invalid ECI position - NaN detected`);
            }
            errorCount++;
            return;
          }
          
          // Debug: Log first satellite position occasionally
          if (index === 0 && Date.now() % 5000 < 1000) {
            updateTerminalLog('3D', `Sat ${index} ECI: ${positionEci.x.toFixed(0)}, ${positionEci.y.toFixed(0)}, ${positionEci.z.toFixed(0)}`);
          }
          
          if (orbitalMotion) {
            // Convert ECI to 3D coordinates 
            sat.position.set(
              positionEci.x,
              positionEci.z, // Y is up in Three.js
              -positionEci.y
            );
          }
          
          // Update visibility and color based on observer
          if (obs && sat.material) {
            const gmst = satellite.gstime(currentTime);
            const observerGd = {
              latitude: satellite.degreesToRadians(obs.lat),
              longitude: satellite.degreesToRadians(obs.lon),
              height: obs.height
            };
            
            const positionEcf = satellite.eciToEcf(positionEci, gmst);
            const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);
            const elevation = satellite.radiansToDegrees(lookAngles.elevation);
            
            const isVisible = elevation >= (obs.elevMin || 25);
            
            // Update color and opacity - check if material methods exist
            if (sat.material.color && sat.material.color.setHex) {
              if (isVisible) {
                sat.material.color.setHex(0x00ff00);
                if (sat.material.emissive && sat.material.emissive.setHex) {
                  sat.material.emissive.setHex(0x00ff00);
                  sat.material.emissiveIntensity = 0.8;
                }
              } else {
                sat.material.color.setHex(0x666666);
                if (sat.material.emissive && sat.material.emissive.setHex) {
                  sat.material.emissive.setHex(0x222222);
                  sat.material.emissiveIntensity = 0.2;
                }
              }
            }
          }
          
          updatedCount++;
          
        } catch (e) {
          if (errorCount < 5) { // Only log first few errors to avoid spam
            updateTerminalLog('3D', `Error updating satellite ${index}: ${e.message}`);
          }
          errorCount++;
        }
      });
      
      // Debug log every 10 seconds
      if (Date.now() % 10000 < 1000) {
        updateTerminalLog('3D', `Updated ${updatedCount}/${satellites3D.length} satellites (${errorCount} errors)`);
      }
    }
    
    // ==================== CONTROLES ====================
    
    function setupControls() {
      document.getElementById('btnApply').addEventListener('click', () => {
        setObserverLocation();
        updateSatellites(); // Force immediate update
        updateTerminalLog('CMD', 'Observer location updated and satellites refreshed');
      });
    }
    
    function setupGlobeControls() {
      const container = document.getElementById('globe');
      if (!container) return;
      
      let mouseDown = false;
      let mouseX = 0;
      let mouseY = 0;
      
      container.addEventListener('mousedown', (e) => {
        mouseDown = true;
        mouseX = e.clientX;
        mouseY = e.clientY;
      });
      
      container.addEventListener('mousemove', (e) => {
        if (!mouseDown || !camera3D) return;
        
        const deltaX = e.clientX - mouseX;
        const deltaY = e.clientY - mouseY;
        
        // Rotate camera around origin
        const spherical = new THREE.Spherical();
        spherical.setFromVector3(camera3D.position);
        spherical.theta -= deltaX * 0.01;
        spherical.phi += deltaY * 0.01;
        spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
        camera3D.position.setFromSpherical(spherical);
        camera3D.lookAt(0, 0, 0);
        
        mouseX = e.clientX;
        mouseY = e.clientY;
      });
      
      container.addEventListener('mouseup', () => {
        mouseDown = false;
      });
      
      container.addEventListener('wheel', (e) => {
        if (!camera3D) return;
        const scale = e.deltaY > 0 ? 1.1 : 0.9;
        camera3D.position.multiplyScalar(scale);
        camera3D.position.clampLength(8000, 50000);
      });
      
      // Orbit speed control
      const speedSlider = document.getElementById('orbitSpeed');
      if (speedSlider) {
        speedSlider.addEventListener('input', (e) => {
          orbitSpeedMultiplier = parseInt(e.target.value);
          updateTerminalLog('3D', `Orbit speed: ${orbitSpeedMultiplier}x`);
        });
      }
    }
    
    // ==================== ANIMAÇÃO ====================
    
    let lastTime = 0;
    let frameCount = 0;
    
    function animate3D() {
      if (currentView !== 'globe' || !globe3D) {
        animationId = null;
        return;
      }
      
      animationId = requestAnimationFrame(animate3D);
      
      // FPS Counter
      frameCount++;
      const currentTime = performance.now();
      if (currentTime >= lastTime + 1000) {
        const fps = document.getElementById('globe-fps');
        if (fps) fps.textContent = frameCount;
        frameCount = 0;
        lastTime = currentTime;
      }
      
      // Update time display
      const timeEl = document.getElementById('globe-time');
      if (timeEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('pt-BR');
      }
      
      // Auto rotate Earth
      if (autoRotate && earthMesh) {
        earthMesh.rotation.y += 0.002;
      }
      
      // SEMPRE atualizar satélites (mesmo com orbital motion pausado, para debug)
      update3DSatellites();
      
      // Render
      if (renderer3D && scene3D && camera3D) {
        renderer3D.render(scene3D, camera3D);
      }
    }
    
    // ==================== FUNÇÕES DE CONTROLE ====================
    
    function switchView(view) {
      currentView = view;
      
      // Update tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update views
      document.querySelectorAll('.view-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(view + '-view').classList.add('active');
      
      // Initialize 3D if needed
      if (view === 'globe' && !globe3D) {
        setTimeout(() => init3DGlobe(), 100);
      }
      
      // Start/stop animation
      if (view === 'globe' && globe3D) {
        animate3D();
      }
      
      updateTerminalLog('VIEW', `Switched to ${view.toUpperCase()} view`);
    }
    
    function resetGlobeView() {
      if (camera3D) {
        camera3D.position.set(12000, 8000, 12000);
        camera3D.lookAt(0, 0, 0);
      }
      if (earthMesh) {
        earthMesh.rotation.set(0, 0, 0);
      }
      updateTerminalLog('3D', 'View reset');
    }
    
    function toggleRotation() {
      autoRotate = !autoRotate;
      const rotEl = document.getElementById('globe-rotation');
      if (rotEl) rotEl.textContent = autoRotate ? 'ON' : 'OFF';
      updateTerminalLog('3D', `Auto-rotation ${autoRotate ? 'enabled' : 'disabled'}`);
    }
    
    function createTestSatellites() {
      updateTerminalLog('TEST', 'Creating test satellites in fixed positions...');
      
      // Clear existing satellites
      satellites3D.forEach(sat => {
        if (sat.parent) {
          sat.parent.remove(sat);
        }
      });
      satellites3D = [];
      
      // Create simple test satellites in fixed positions around Earth
      const testPositions = [
        { x: 10000, y: 2000, z: 2000, name: 'TEST-SAT-1' },
        { x: -8000, y: 3000, z: 4000, name: 'TEST-SAT-2' },
        { x: 5000, y: -7000, z: 6000, name: 'TEST-SAT-3' },
        { x: -3000, y: 8000, z: -5000, name: 'TEST-SAT-4' },
        { x: 7000, y: 4000, z: -8000, name: 'TEST-SAT-5' }
      ];
      
      const satGeometry = new THREE.SphereGeometry(300, 16, 16); // Even bigger for testing
      
      testPositions.forEach((pos, index) => {
        const material = new THREE.MeshBasicMaterial({
          color: new THREE.Color(0x00ff00),
          transparent: false
        });
        material.emissive = new THREE.Color(0x00ff00);
        material.emissiveIntensity = 1.0;
        
        const satellite = new THREE.Mesh(satGeometry, material);
        satellite.position.set(pos.x, pos.y, pos.z);
        
        satellite.userData = {
          index: index,
          name: pos.name,
          isTest: true
        };
        
        // Add a bright glow
        const glowGeometry = new THREE.SphereGeometry(400, 8, 8);
        const glowMaterial = new THREE.MeshBasicMaterial({
          color: new THREE.Color(0x00ff00),
          transparent: true,
          opacity: 0.5
        });
        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
        satellite.add(glow);
        
        scene3D.add(satellite);
        satellites3D.push(satellite);
        
        updateTerminalLog('TEST', `✓ ${pos.name} created at ${pos.x}, ${pos.y}, ${pos.z}`);
      });
      
      document.getElementById('globe-sats').textContent = satellites3D.length;
      updateTerminalLog('TEST', `${satellites3D.length} test satellites created and visible`);
      
      // Disable orbital motion for test satellites
      orbitalMotion = false;
      const orbEl = document.getElementById('globe-orbits');
      if (orbEl) orbEl.textContent = 'TEST MODE';
    }
    
    function debugSatellites() {
      updateTerminalLog('DEBUG', `=== SATELLITE DEBUG INFO ===`);
      updateTerminalLog('DEBUG', `Satellites3D array length: ${satellites3D.length}`);
      updateTerminalLog('DEBUG', `SatRecs array length: ${satRecs.length}`);
      updateTerminalLog('DEBUG', `TLE list length: ${tleList.length}`);
      updateTerminalLog('DEBUG', `Orbital motion: ${orbitalMotion}`);
      updateTerminalLog('DEBUG', `Globe3D initialized: ${globe3D}`);
      updateTerminalLog('DEBUG', `Observer: ${obs ? `${obs.lat}, ${obs.lon}` : 'null'}`);
      
      if (scene3D) {
        updateTerminalLog('DEBUG', `Scene children count: ${scene3D.children.length}`);
      }
      
      if (camera3D) {
        updateTerminalLog('DEBUG', `Camera position: ${camera3D.position.x.toFixed(0)}, ${camera3D.position.y.toFixed(0)}, ${camera3D.position.z.toFixed(0)}`);
      }
      
      if (satellites3D.length > 0) {
        const sat = satellites3D[0];
        updateTerminalLog('DEBUG', `First satellite position: ${sat.position.x.toFixed(0)}, ${sat.position.y.toFixed(0)}, ${sat.position.z.toFixed(0)}`);
        updateTerminalLog('DEBUG', `First satellite visible: ${sat.visible}`);
        updateTerminalLog('DEBUG', `First satellite material: ${sat.material ? 'exists' : 'missing'}`);
        
        // Test propagation
        if (sat.userData.rec) {
          try {
            const testTime = new Date();
            const result = satellite.propagate(sat.userData.rec, testTime);
            if (result.position) {
              updateTerminalLog('DEBUG', `Test propagation: ${result.position.x.toFixed(0)}, ${result.position.y.toFixed(0)}, ${result.position.z.toFixed(0)}`);
            } else {
              updateTerminalLog('DEBUG', `Test propagation: FAILED - no position`);
            }
          } catch (e) {
            updateTerminalLog('DEBUG', `Test propagation: ERROR - ${e.message}`);
          }
        }
      }
      
      // Force recreation of satellites with fresh data
      updateTerminalLog('DEBUG', `Forcing satellite recreation...`);
      create3DSatellites();
    }
    
    function toggleOrbitalMotion() {
      orbitalMotion = !orbitalMotion;
      const orbEl = document.getElementById('globe-orbits');
      if (orbEl) orbEl.textContent = orbitalMotion ? 'ACTIVE' : 'PAUSED';
      const btn = event.target;
      if (btn) btn.textContent = orbitalMotion ? 'PAUSE ORBITS' : 'RESUME ORBITS';
      updateTerminalLog('3D', `Orbital motion ${orbitalMotion ? 'resumed' : 'paused'}`);
    }
    
    // ==================== UTILITÁRIOS ====================
    
    function updateTerminalLog(type, message) {
      const time = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
      
      const terminal = document.getElementById('terminalOutput');
      if (terminal) {
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.innerHTML = `<span class="time">[${time}]</span> <span class="type">[${type}]</span> <span class="message">${message}</span>`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
        
        // Keep only last 50 lines
        while (terminal.children.length > 50) {
          terminal.removeChild(terminal.firstChild);
        }
      }
    }
    
    function updateStats(visible, tracked, total) {
      document.getElementById('stat-visible').textContent = visible || 0;
      document.getElementById('stat-tracked').textContent = tracked || 0;
      document.getElementById('stat-total').textContent = total || 0;
    }
    
    // ==================== EVENT LISTENERS ====================
    
    window.addEventListener('resize', () => {
      if (renderer3D && camera3D) {
        const container = document.getElementById('globe');
        if (container) {
          camera3D.aspect = container.clientWidth / container.clientHeight;
          camera3D.updateProjectionMatrix();
          renderer3D.setSize(container.clientWidth, container.clientHeight);
        }
      }
    });
    
    // Export functions to global scope
    window.switchView = switchView;
    window.resetGlobeView = resetGlobeView;
    window.toggleRotation = toggleRotation;
    window.toggleOrbitalMotion = toggleOrbitalMotion;
    window.debugSatellites = debugSatellites;
    window.createTestSatellites = createTestSatellites;
    
    // ==================== INICIALIZAÇÃO ====================
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Initialize immediately if DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
