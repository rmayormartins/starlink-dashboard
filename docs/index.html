<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>STARLINK TACTICAL OPERATIONS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Satellite.js -->
  <script src="https://unpkg.com/satellite.js@5.0.0/dist/satellite.min.js"></script>
  
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #000000;
      color: #999999;
      font-size: 12px;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      height: 50px;
      background: #1a1a1a;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      background: #ff0000;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
      50% { opacity: 0.3; box-shadow: 0 0 0 10px rgba(255,0,0,0); }
    }
    
    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    
    .header-stats {
      display: flex;
      gap: 30px;
      font-family: 'Share Tech Mono', monospace;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-size: 20px;
      color: #ffffff;
      font-weight: 500;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666666;
      text-transform: uppercase;
    }
    
    #meta {
      font-size: 11px;
      color: #00ff00;
      margin-left: 20px;
    }
    
    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background: #0a0a0a;
    }
    
    /* Left Panel */
    .left-panel {
      width: 320px;
      background: #111111;
      border-right: 1px solid #333333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .left-panel-scrollable {
      flex: 1;
      overflow-y: auto;
    }
    
    .panel-section {
      border-bottom: 1px solid #222222;
    }
    
    .section-title {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #999999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
    }
    
    .section-content {
      padding: 15px;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    .control-label {
      display: block;
      margin-bottom: 5px;
      color: #666666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .control-input {
      width: 100%;
      padding: 6px 10px;
      background: #000000;
      border: 1px solid #333333;
      color: #ffffff;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #ff0000;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #ff0000;
    }
    
    .checkbox-group label {
      color: #999999;
      text-transform: uppercase;
      font-size: 11px;
    }
    
    .btn {
      width: 100%;
      padding: 8px;
      background: #990000;
      border: 1px solid #ff0000;
      color: #ffffff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    
    .btn:hover {
      background: #ff0000;
      box-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    
    /* Terminal */
    .terminal {
      height: 120px;
      background: #000000;
      border: 1px solid #222222;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
    }
    
    .terminal-line {
      margin: 2px 0;
      color: #999999;
    }
    
    .terminal-line .time { color: #666666; }
    .terminal-line .type { color: #ff0000; }
    .terminal-line .message { color: #ffffff; }
    
    /* Map Container */
    .map-container {
      flex: 1;
      position: relative;
      background: #000000;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    /* Map Overlay */
    .map-overlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 15px;
      min-width: 200px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .overlay-title {
      color: #ff0000;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .data-row {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
    }
    
    .data-label {
      color: #666666;
    }
    
    .data-value {
      color: #ffffff;
    }
    
    .data-value.good { color: #00ff00; }
    .data-value.warning { color: #ffaa00; }
    .data-value.critical { color: #ff0000; }
    
    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333333;
      padding: 10px;
      font-size: 11px;
    }
    
    .legend-title {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border: 1px solid #333333;
    }
    
    /* Right Panel - RF Analysis */
    .right-panel {
      width: 400px;
      background: #111111;
      border-left: 1px solid #333333;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    
    .info-card {
      border-bottom: 1px solid #222222;
      flex-shrink: 0;
    }
    
    .card-header {
      padding: 12px 15px;
      background: #1a1a1a;
      color: #ffffff;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .card-content {
      padding: 15px;
    }
    
    .sat-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
    }
    
    .sat-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .sat-info-label {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
    }
    
    .sat-info-value {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .rf-plot {
      height: 160px;
      background: #000000;
      border: 1px solid #222222;
      margin: 10px 0;
    }
    
    .terminal-text {
      font-family: 'Share Tech Mono', monospace;
      white-space: pre;
      line-height: 1.3;
      color: #00ff00;
      font-size: 11px;
    }
    
    /* Weather Display */
    .weather-display {
      background: #000000;
      border: 1px solid #333333;
      padding: 10px;
      margin: 10px 0;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
    }
    
    /* Handover Notification */
    .handover-notification {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 10000;
      animation: slideIn 0.5s;
    }
    
    .terminal-box {
      background: #000000;
      border: 1px solid #00ff00;
      color: #00ff00;
      padding: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      white-space: pre;
      box-shadow: 0 0 20px #00ff00;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #000000; }
    ::-webkit-scrollbar-thumb { background: #333333; }
    ::-webkit-scrollbar-thumb:hover { background: #666666; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <div class="status-indicator"></div>
      <h1>Starlink Tactical Operations</h1>
      <div id="meta">[INITIALIZING...]</div>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-visible">0</div>
        <div class="stat-label">Visible</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tracked">0</div>
        <div class="stat-label">Tracked</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total</div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Panel - Controls & Log -->
    <div class="left-panel">
      <div class="left-panel-scrollable">
        <div class="panel-section">
          <div class="section-title">Target Operation</div>
          <div class="section-content">
            <div class="control-group">
              <label class="control-label">Latitude</label>
              <input type="number" id="lat" class="control-input" value="-27.588" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Longitude</label>
              <input type="number" id="lon" class="control-input" value="-48.613" step="0.001">
            </div>
            <div class="control-group">
              <label class="control-label">Min Elevation (°)</label>
              <input type="number" id="elevMin" class="control-input" value="25" min="0" max="90" step="5">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showFootprints" checked>
              <label for="showFootprints">Show Footprints</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="considerRain" checked>
              <label for="considerRain">Rain Attenuation</label>
            </div>
            <button class="btn" id="btnApply">EXECUTE</button>
            <button class="btn" id="btnHandover">START HANDOVER</button>
          </div>
        </div>
        
        <div class="panel-section">
          <div class="section-title">Mission Status</div>
          <div class="section-content">
            <div id="visibleInfo" style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
              <div class="data-row">
                <span class="data-label">STATUS:</span>
                <span class="data-value">INITIALIZING</span>
              </div>
              <div class="data-row">
                <span class="data-label">RENDER:</span>
                <span class="data-value">0 ms</span>
              </div>
              <div class="data-row">
                <span class="data-label">LINK:</span>
                <span class="data-value good">OPERATIONAL</span>
              </div>
            </div>
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">Weather Data</div>
          <div class="section-content">
            <div id="weatherInfo" class="weather-display">
              <div class="terminal-text">LOADING WEATHER...</div>
            </div>
          </div>
        </div>
        
        <!-- System Log -->
        <div class="panel-section">
          <div class="section-title">System Log</div>
          <div class="section-content" style="padding: 0;">
            <div class="terminal" id="terminalOutput"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Map Overlay -->
      <div class="map-overlay">
        <div class="overlay-title">Target Details</div>
        <div id="targetInfo">
          <div class="data-row">
            <span class="data-label">SAT ID:</span>
            <span class="data-value">---</span>
          </div>
          <div class="data-row">
            <span class="data-label">ELEV:</span>
            <span class="data-value">---</span>
          </div>
          <div class="data-row">
            <span class="data-label">AZIM:</span>
            <span class="data-value">---</span>
          </div>
          <div class="data-row">
            <span class="data-label">RANGE:</span>
            <span class="data-value">---</span>
          </div>
          <div class="data-row">
            <span class="data-label">SNR:</span>
            <span class="data-value">---</span>
          </div>
        </div>
      </div>
      
      <!-- Legend -->
      <div class="legend">
        <div class="legend-title">Satellite Status</div>
        <div class="legend-item">
          <div class="legend-color" style="background: #00ff00;"></div>
          <span style="color: #999999;">VISIBLE</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ffffff;"></div>
          <span style="color: #999999;">SERVING</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ffff00;"></div>
          <span style="color: #999999;">CANDIDATE</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ff00ff;"></div>
          <span style="color: #999999;">SELECTED</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #333333;"></div>
          <span style="color: #999999;">INACTIVE</span>
        </div>
      </div>
    </div>

    <!-- Right Panel - RF Analysis -->
    <div class="right-panel">
      <!-- Selected Satellite Data -->
      <div class="info-card">
        <div class="card-header">Satellite Data</div>
        <div class="card-content">
          <div id="sat-info" class="sat-info-grid">
            <div class="sat-info-item">
              <span class="sat-info-label">NORAD</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">NAME</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ALTITUDE</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">VELOCITY</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">ELEVATION</span>
              <span class="sat-info-value">---</span>
            </div>
            <div class="sat-info-item">
              <span class="sat-info-label">AZIMUTH</span>
              <span class="sat-info-value">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- RF Link Analysis -->
      <div class="info-card">
        <div class="card-header">RF Link Analysis</div>
        <div class="card-content">
          <div style="font-family: 'Share Tech Mono', monospace; font-size: 11px;">
            <div class="data-row">
              <span class="data-label">FREQ DL:</span>
              <span class="data-value">10.7-12.7 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">FREQ UL:</span>
              <span class="data-value">14.0-14.5 GHz</span>
            </div>
            <div class="data-row">
              <span class="data-label">SNR:</span>
              <span class="data-value" id="rf-snr">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">RX POWER:</span>
              <span class="data-value" id="rf-power">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">FSPL:</span>
              <span class="data-value" id="rf-fspl">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">RAIN ATT:</span>
              <span class="data-value" id="rf-rain">---</span>
            </div>
            <div class="data-row">
              <span class="data-label">LINK STATUS:</span>
              <span class="data-value" id="rf-status">---</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Handover Status -->
      <div class="info-card">
        <div class="card-header">Handover Status</div>
        <div class="card-content">
          <div id="handoverInfo">
            <div class="terminal-text">HANDOVER INACTIVE</div>
          </div>
        </div>
      </div>
      
      <!-- RF Analysis Plots -->
      <div class="info-card">
        <div class="card-header">Signal Analysis</div>
        <div class="card-content">
          <div id="snrPlot" class="rf-plot"></div>
          <div id="constPlot" class="rf-plot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ==================== CONFIGURAÇÃO GLOBAL ====================
    const DATA_URL = "data/starlink_tle.json";
    const META_URL = "data/meta.json";
    const REFRESH_MS = 3000;
    
    // TLEs de fallback válidos (Gen2 Starlink)
    const FALLBACK_TLEs = [
      {
        "name": "STARLINK-30440",
        "noradId": "57812",
        "line1": "1 57812U 23126W   24219.25000000  .00000832  00000-0  73125-4 0  9995",
        "line2": "2 57812  43.0010 315.8972 0.0003456 268.7432  91.3456 15.02531234 52348"
      },
      {
        "name": "STARLINK-30441",
        "noradId": "57813",
        "line1": "1 57813U 23126X   24219.26000000  .00000945  00000-0  81234-4 0  9993",
        "line2": "2 57813  43.0012 316.1234 0.0002987 269.1234  90.8765 15.02531456 52349"
      },
      {
        "name": "STARLINK-30442",
        "noradId": "57814",
        "line1": "1 57814U 23126Y   24219.27000000  .00000756  00000-0  69876-4 0  9991",
        "line2": "2 57814  43.0008 315.7654 0.0003789 268.9876  91.0123 15.02531678 52350"
      },
      {
        "name": "STARLINK-30443",
        "noradId": "57815",
        "line1": "1 57815U 23126Z   24219.28000000  .00000634  00000-0  58901-4 0  9990",
        "line2": "2 57815  43.0015 316.2345 0.0002456 269.3456  90.6543 15.02531890 52351"
      },
      {
        "name": "STARLINK-30444",
        "noradId": "57816",
        "line1": "1 57816U 23126AA  24219.29000000  .00000723  00000-0  65432-4 0  9992",
        "line2": "2 57816  43.0009 315.9876 0.0003123 268.8765  91.1234 15.02532102 52352"
      },
      {
        "name": "STARLINK-31001",
        "noradId": "58001",
        "line1": "1 58001U 23127A   24219.30000000  .00000512  00000-0  52341-4 0  9994",
        "line2": "2 58001  43.0020 325.1234 0.0002134 267.5678 92.4321 15.02530987 52360"
      },
      {
        "name": "STARLINK-31002",
        "noradId": "58002",
        "line1": "1 58002U 23127B   24219.31000000  .00000623  00000-0  61234-4 0  9996",
        "line2": "2 58002  43.0018 324.9876 0.0002567 268.1234 91.8765 15.02531123 52361"
      },
      {
        "name": "STARLINK-31003",
        "noradId": "58003",
        "line1": "1 58003U 23127C   24219.32000000  .00000734  00000-0  72567-4 0  9998",
        "line2": "2 58003  43.0016 324.7654 0.0002890 268.6789 91.3210 15.02531456 52362"
      }
    ];
    
    // ==================== ESTADO GLOBAL ====================
    let tleList = [];
    let satRecs = [];
    let map, layerGroup, footprintGroup;
    let obs = { lat: -27.588, lon: -48.613, elevMin: 25 };
    let selectedSatellite = null;
    let isDrawing = false;
    
    let config = {
      considerRain: true,
      showFootprints: true,
      maxFootprints: 5
    };
    
    // Estado para Handover
    let handoverSimulation = false;
    let currentServingSat = null;
    let handoverCandidates = [];
    
    // Cache de clima
    let weatherData = null;
    let weatherLastFetch = 0;
    
    // ==================== INICIALIZAÇÃO ====================
    
    async function init() {
      updateTerminalLog("SYSTEM", "Initializing Starlink Tactical Operations...");
      
      console.log(`%c
╔═══════════════════════════════════════════╗
║     STARLINK TACTICAL OPERATIONS         ║
║         CENTRO OPERACIONAL TÁTICO        ║
╚═══════════════════════════════════════════╝
      `, "color: #00ff00; font-family: monospace");
      
      try {
        await loadSatelliteData();
        init2DMap();
        setupControls();
        setObserverLocation();
        await fetchWeatherData();
        startSimulation();
        updateTerminalLog("SYSTEM", "TACTICAL OPERATIONS CENTER ONLINE");
      } catch (e) {
        updateTerminalLog("ERROR", `Critical failure: ${e.message}`);
      }
    }
    
    async function loadSatelliteData() {
      updateTerminalLog("DATA", "Loading satellite orbital elements...");
      
      try {
        // Tentar carregar metadados primeiro
        try {
          const metaResponse = await fetch(META_URL);
          if (metaResponse.ok) {
            const meta = await metaResponse.json();
            document.getElementById("meta").innerHTML = 
              `[SATS: ${meta.count}] [SRC: ${meta.source}] [UPD: ${new Date(meta.updatedAt).toLocaleString('pt-BR')}]`;
            updateTerminalLog("DATA", `Metadata loaded: ${meta.count} satellites`);
          }
        } catch (e) {
          updateTerminalLog("WARNING", "Metadata not available");
        }
        
        // Tentar carregar dados externos
        const dataResponse = await fetch(DATA_URL);
        if (dataResponse.ok) {
          tleList = await dataResponse.json();
          updateTerminalLog("DATA", `${tleList.length} TLEs loaded from external source`);
        } else {
          throw new Error("External data not available");
        }
        
      } catch (e) {
        updateTerminalLog("WARNING", `External data unavailable: ${e.message}`);
        updateTerminalLog("DATA", "Switching to tactical fallback constellation...");
        
        tleList = FALLBACK_TLEs;
        document.getElementById("meta").innerHTML = `[FALLBACK MODE] [SATS: ${tleList.length}] [STATUS: TACTICAL]`;
        updateTerminalLog("DATA", `${tleList.length} tactical satellites loaded from fallback`);
      }
      
      // Processar TLEs
      updateTerminalLog("CALC", "Processing orbital elements with SGP4...");
      parseTLEData();
    }
    
    function parseTLEData() {
      satRecs = [];
      let validCount = 0;
      
      tleList.forEach((tle, index) => {
        try {
          if (!tle.line1 || !tle.line2) {
            updateTerminalLog("TLE", `Invalid TLE format for ${tle.name || index}`);
            satRecs.push(null);
            return;
          }
          
          const satrec = satellite.twoline2satrec(tle.line1, tle.line2);
          
          if (satrec.error) {
            updateTerminalLog("TLE", `SGP4 error for ${tle.name}: ${satrec.error}`);
            satRecs.push(null);
            return;
          }
          
          // Test propagation
          const testTime = new Date();
          const testResult = satellite.propagate(satrec, testTime);
          
          if (!testResult.position || isNaN(testResult.position.x)) {
            updateTerminalLog("TLE", `Propagation failed for ${tle.name}`);
            satRecs.push(null);
            return;
          }
          
          satRecs.push(satrec);
          validCount++;
          
        } catch (e) {
          updateTerminalLog("TLE", `Error processing ${tle.name}: ${e.message}`);
          satRecs.push(null);
        }
      });
      
      updateTerminalLog("CALC", `${validCount}/${tleList.length} satellites ready for tracking`);
      updateStats(0, 0, validCount);
    }
    
    function init2DMap() {
      updateTerminalLog("MAP", "Initializing tactical map system...");
      
      map = L.map("map", { 
        worldCopyJump: true,
        preferCanvas: true,
        renderer: L.canvas(),
        zoomControl: false
      }).setView([obs.lat, obs.lon], 3);
      
      // Dark tactical map
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© TACTICAL MAP',
        subdomains: 'abcd',
        maxZoom: 10,
        minZoom: 2
      }).addTo(map);
      
      // Layer groups
      layerGroup = L.layerGroup().addTo(map);
      footprintGroup = L.layerGroup().addTo(map);
      
      // Observer location marker
      const observerIcon = L.divIcon({
        html: '<div style="width: 12px; height: 12px; background: #ff0000; border: 2px solid #ffffff; border-radius: 50%; box-shadow: 0 0 10px #ff0000;"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });
      
      L.marker([obs.lat, obs.lon], { icon: observerIcon }).addTo(map)
        .bindPopup('<strong>TACTICAL BASE</strong><br>Campinas, SC<br>Status: OPERATIONAL');
      
      updateTerminalLog("MAP", "Tactical map system online");
    }
    
    function setupControls() {
      document.getElementById("btnApply").addEventListener('click', () => {
        setObserverLocation();
        fetchWeatherData();
        updateSatellites();
        updateTerminalLog("CMD", "Tactical parameters updated");
      });
      
      // Checkbox controls
      document.getElementById("showFootprints").addEventListener('change', (e) => {
        config.showFootprints = e.target.checked;
        updateTerminalLog("CONFIG", `Footprints ${config.showFootprints ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      document.getElementById("considerRain").addEventListener('change', (e) => {
        config.considerRain = e.target.checked;
        updateTerminalLog("CONFIG", `Rain attenuation ${config.considerRain ? 'enabled' : 'disabled'}`);
        updateSatellites();
      });
      
      // Handover button
      document.getElementById("btnHandover").addEventListener('click', () => {
        handoverSimulation = !handoverSimulation;
        const btn = document.getElementById("btnHandover");
        btn.textContent = handoverSimulation ? "STOP HANDOVER" : "START HANDOVER";
        updateTerminalLog("HANDOVER", handoverSimulation ? "Simulation started" : "Simulation stopped");
        
        if (!handoverSimulation) {
          currentServingSat = null;
          handoverCandidates = [];
          updateHandoverDisplay();
        }
      });
    }
    
    function setObserverLocation() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const elevMin = parseFloat(document.getElementById('elevMin').value);
      
      if (isNaN(lat) || isNaN(lon) || isNaN(elevMin)) {
        updateTerminalLog('OBS', 'Invalid tactical coordinates');
        return;
      }
      
      obs = {
        lat: lat,
        lon: lon,
        elevMin: elevMin,
        height: 0
      };
      
      if (map) {
        map.setView([lat, lon], map.getZoom());
      }
      
      updateTerminalLog('OBS', `Tactical position: ${lat.toFixed(3)}°N, ${lon.toFixed(3)}°W, Elev>${elevMin}°`);
    }
    
    async function fetchWeatherData() {
      const now = Date.now();
      
      if (weatherData && (now - weatherLastFetch) < 30 * 60 * 1000) {
        return weatherData;
      }
      
      try {
        updateTerminalLog("WEATHER", "Fetching atmospheric data...");
        
        // Simular dados realistas
        weatherData = {
          cloudCover: Math.random() * 100,
          precipitation: Math.random() * 10,
          humidity: 60 + Math.random() * 30,
          temperature: 20 + Math.random() * 15
        };
        
        weatherLastFetch = now;
        updateWeatherDisplay();
        updateTerminalLog("WEATHER", `Precipitation: ${weatherData.precipitation.toFixed(1)}mm/h`);
        
      } catch (e) {
        updateTerminalLog("ERROR", `Weather data fetch failed: ${e.message}`);
        weatherData = { cloudCover: 0, precipitation: 0, humidity: 70, temperature: 25 };
      }
      
      return weatherData;
    }
    
    function updateWeatherDisplay() {
      if (!weatherData) return;
      
      const weatherInfo = document.getElementById("weatherInfo");
      if (weatherInfo) {
        const rainAtt = config.considerRain ? calculateRainAttenuation(45, weatherData.precipitation) : 0;
        weatherInfo.innerHTML = `
          <div class="terminal-text">
┌─ ATMOSPHERIC CONDITIONS ─┐
│ CLOUDS......: ${weatherData.cloudCover.toFixed(0).padStart(3)}%       │
│ PRECIP......: ${weatherData.precipitation.toFixed(1).padStart(4)} mm/h  │
│ HUMIDITY....: ${weatherData.humidity.toFixed(0).padStart(3)}%       │
│ TEMP........: ${weatherData.temperature.toFixed(1).padStart(4)}°C     │
│ RAIN ATT....: ${rainAtt.toFixed(1).padStart(4)} dB    │
└──────────────────────────┘
          </div>
        `;
      }
    }
    
    function startSimulation() {
      updateTerminalLog('SIM', 'Starting real-time orbital tracking...');
      
      // Main update loop
      setInterval(() => {
        if (!isDrawing) {
          updateSatellites();
          if (handoverSimulation) simulateHandover();
        }
      }, REFRESH_MS);
      
      // Plot updates
      setInterval(updateRFPlots, 5000);
      
      // Initial update
      updateSatellites();
    }
    
    // ==================== CÁLCULOS DE SATÉLITE ====================
    
    function getSatState(rec, time = new Date()) {
      try {
        if (!rec) return null;
        
        const gmst = satellite.gstime(time);
        const pv = satellite.propagate(rec, time);
        
        if (!pv || !pv.position || pv.position === false) return null;
        
        const eci = pv.position;
        const vel = pv.velocity || {x: 0, y: 0, z: 0};
        const gd = satellite.eciToGeodetic(eci, gmst);
        
        const lat = satellite.radiansToDegrees(gd.latitude);
        const lon = satellite.radiansToDegrees(gd.longitude);
        const alt = gd.height;
        
        const speed = Math.sqrt(vel.x**2 + vel.y**2 + vel.z**2);
        
        // Calculate look angles from observer
        const obsGd = {
          latitude: satellite.degreesToRadians(obs.lat),
          longitude: satellite.degreesToRadians(obs.lon),
          height: 0
        };
        
        const satEcf = satellite.eciToEcf(eci, gmst);
        const look = satellite.ecfToLookAngles(obsGd, satEcf);
        
        const az = satellite.radiansToDegrees(look.azimuth);
        const el = satellite.radiansToDegrees(look.elevation);
        const range = look.rangeSat;
        
        return { lat, lon, alt, az, el, range, speed };
      } catch (err) {
        return null;
      }
    }
    
    function calculateLinkBudget(elevationDeg, rainAttenuation = 0) {
      const FREQ = 11.5e9; // Hz (Ku-band downlink)
      const EIRP = 35; // dBW (satellite EIRP)
      const GAIN = 33; // dBi (user terminal gain)
      
      // Free space path loss calculation
      const distance = 550 / Math.sin(Math.max(elevationDeg, 1) * Math.PI / 180);
      const FSPL = 20 * Math.log10(distance * 1000) + 20 * Math.log10(FREQ) + 92.45;
      
      // Atmospheric losses (higher at low elevations)
      const atmosphericLoss = 0.5 / Math.sin(Math.max(elevationDeg, 5) * Math.PI / 180);
      
      // Aplicar atenuação por chuva apenas se configurado
      const appliedRainAtt = config.considerRain ? rainAttenuation : 0;
      
      const rxPower = EIRP - FSPL - atmosphericLoss - appliedRainAtt + GAIN;
      const noiseFloor = -134; // dBm
      const SNR = rxPower - noiseFloor;
      
      return { SNR, rxPower, FSPL, rainAttenuation: appliedRainAtt };
    }
    
    function calculateRainAttenuation(elevation, precipitation) {
      if (precipitation === 0 || !config.considerRain) return 0;
      
      const freq = 11.5; // GHz
      const k = 0.0101 * Math.pow(freq, 2.03);
      const alpha = 1.065;
      
      const slantPath = 550 / Math.sin(Math.max(elevation, 5) * Math.PI / 180);
      const attenuation = k * Math.pow(precipitation, alpha) * Math.min(slantPath / 10, 5);
      
      return Math.min(attenuation, 20);
    }
    
    // ==================== HANDOVER ====================
    
    function simulateHandover() {
      if (!currentServingSat) {
        const visible = [];
        
        for (let i = 0; i < tleList.length; i++) {
          const rec = satRecs[i];
          if (!rec) continue;
          
          const st = getSatState(rec);
          if (!st || st.el < obs.elevMin) continue;
          
          const rainAtt = config.considerRain && weatherData ? 
            calculateRainAttenuation(st.el, weatherData.precipitation) : 0;
          const linkBudget = calculateLinkBudget(st.el, rainAtt);
          
          visible.push({
            satellite: tleList[i],
            state: st,
            snr: linkBudget.SNR,
            index: i
          });
        }
        
        if (visible.length > 0) {
          visible.sort((a, b) => b.snr - a.snr);
          currentServingSat = visible[0];
          handoverCandidates = visible.slice(1, 4);
          
          updateTerminalLog("HANDOVER", `Serving: ${currentServingSat.satellite.name} [SNR: ${currentServingSat.snr.toFixed(1)}dB]`);
        }
      } else {
        const currentState = getSatState(satRecs[currentServingSat.index]);
        
        if (!currentState || currentState.el < obs.elevMin - 5) {
          updateTerminalLog("HANDOVER", `Signal degradation detected on ${currentServingSat.satellite.name}`);
          
          if (handoverCandidates.length > 0) {
            const newServing = handoverCandidates[0];
            updateTerminalLog("HANDOVER", `Executing handover to ${newServing.satellite.name}`);
            
            showHandoverNotification(currentServingSat.satellite.name, newServing.satellite.name);
            
            currentServingSat = newServing;
            handoverCandidates = handoverCandidates.slice(1);
          } else {
            currentServingSat = null;
            updateTerminalLog("HANDOVER", "No candidates available - connection lost");
          }
        }
      }
      
      updateHandoverDisplay();
    }
    
    function showHandoverNotification(from, to) {
      const notification = document.createElement("div");
      notification.className = "handover-notification";
      notification.innerHTML = `
        <div class="terminal-box">
╔════ HANDOVER EXECUTED ════╗
║ FROM: ${from.padEnd(20)} ║
║ TO..: ${to.padEnd(20)} ║
╚═══════════════════════════╝
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = "fadeOut 0.5s";
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }
    
    function updateHandoverDisplay() {
      const handoverInfo = document.getElementById("handoverInfo");
      if (!handoverInfo) return;
      
      let html = '<div class="terminal-text">';
      
      if (currentServingSat) {
        const state = getSatState(satRecs[currentServingSat.index]);
        if (state) {
          html += `
┌─ SERVING SATELLITE ─┐
│ ${(currentServingSat.satellite.name || 'UNKNOWN').padEnd(18)} │
│ SNR: ${currentServingSat.snr.toFixed(1)} dB          │
│ EL.: ${state.el.toFixed(1)}°             │
└────────────────────┘
`;
        }
      }
      
      if (handoverCandidates.length > 0) {
        html += '\nCANDIDATES:\n';
        handoverCandidates.forEach((c, i) => {
          html += `${i+1}. ${c.satellite.name} [${c.snr.toFixed(1)}dB]\n`;
        });
      }
      
      if (!currentServingSat && handoverCandidates.length === 0) {
        html += 'HANDOVER INACTIVE\nNo satellites available';
      }
      
      html += '</div>';
      handoverInfo.innerHTML = html;
    }
    
    // ==================== ATUALIZAÇÃO DE SATÉLITES ====================
    
    function updateSatellites() {
      if (isDrawing) return;
      isDrawing = true;
      
      const startTime = performance.now();
      
      layerGroup.clearLayers();
      footprintGroup.clearLayers();
      
      let visible = 0;
      let drawn = 0;
      const MAX_DRAW = 1000;
      const step = Math.ceil(tleList.length / MAX_DRAW);
      
      for (let i = 0; i < tleList.length; i += step) {
        const t = tleList[i];
        const rec = satRecs[i];
        
        if (!rec) continue;
        
        const st = getSatState(rec);
        if (!st) continue;
        
        const isVisible = st.el >= obs.elevMin;
        const isServing = currentServingSat && currentServingSat.index === i;
        const isCandidate = handoverCandidates.some(c => c.index === i);
        const isSelected = selectedSatellite && selectedSatellite.index === i;
        
        // Tactical color scheme
        let color = '#004400'; // Dark green: not visible
        let radius = 2;
        let opacity = 0.3;
        
        if (isServing) {
          color = '#ffffff'; // White: serving
          radius = 6;
          opacity = 1;
        } else if (isCandidate) {
          color = '#ffff00'; // Yellow: candidate
          radius = 4;
          opacity = 0.8;
        } else if (isSelected) {
          color = '#ff00ff'; // Magenta: selected
          radius = 5;
          opacity = 0.9;
        } else if (isVisible) {
          color = '#00ff00'; // Bright green: visible
          radius = 3;
          opacity = 0.7;
          visible++;
        }
        
        const marker = L.circleMarker([st.lat, st.lon], {
          radius: radius,
          weight: 1,
          color: color,
          fillColor: color,
          fillOpacity: opacity,
          opacity: opacity + 0.2
        });
        
        const rainAtt = config.considerRain && weatherData ? 
          calculateRainAttenuation(st.el, weatherData.precipitation) : 0;
        const linkBudget = calculateLinkBudget(st.el, rainAtt);
        
        marker.bindPopup(`
          <div class="terminal-popup">
<strong>[${t.name || "SAT"}]</strong>
NORAD: ${t.noradId}
ALT..: ${st.alt.toFixed(0)} km
ELEV.: ${st.el.toFixed(1)}°
AZIM.: ${st.az.toFixed(1)}°
SNR..: ${linkBudget.SNR.toFixed(1)} dB
${config.considerRain ? `RAIN.: ${rainAtt.toFixed(1)} dB` : 'RAIN.: DISABLED'}
          </div>
        `);
        
        marker.on('click', () => selectSatellite(i, t, rec, st));
        marker.addTo(layerGroup);
        drawn++;
        
        // Footprints
        if (config.showFootprints && isVisible && visible <= config.maxFootprints) {
          const footprintRadius = calculateFootprintRadius(st.alt, obs.elevMin);
          L.circle([st.lat, st.lon], {
            radius: footprintRadius * 1000,
            color: '#00ff00',
            weight: 2,
            opacity: 0.6,
            fillColor: '#00ff00',
            fillOpacity: 0.1,
            interactive: false,
            dashArray: '5,10'
          }).addTo(footprintGroup);
        }
      }
      
      const elapsed = performance.now() - startTime;
      
      // Update mission status
      document.getElementById("visibleInfo").innerHTML = `
        <div class="data-row">
          <span class="data-label">STATUS:</span>
          <span class="data-value good">OPERATIONAL</span>
        </div>
        <div class="data-row">
          <span class="data-label">RENDER:</span>
          <span class="data-value">${elapsed.toFixed(0)} ms</span>
        </div>
        <div class="data-row">
          <span class="data-label">LINK:</span>
          <span class="data-value good">ACTIVE</span>
        </div>
      `;
      
      updateStats(visible, drawn, satRecs.filter(r => r !== null).length);
      isDrawing = false;
    }
    
    function calculateFootprintRadius(altKm, elevMinDeg) {
      const Re = 6371; // Earth radius km
      const h = altKm;
      const e = elevMinDeg * Math.PI / 180;
      const psi = Math.acos((Re/(Re+h)) * Math.cos(e)) - e;
      return Re * psi;
    }
    
    function selectSatellite(index, t, rec, st) {
      selectedSatellite = { index, tle: t, rec, state: st };
      
      const rainAtt = config.considerRain && weatherData ? 
        calculateRainAttenuation(st.el, weatherData.precipitation) : 0;
      const linkBudget = calculateLinkBudget(st.el, rainAtt);
      
      // Update target overlay
      const targetInfo = document.getElementById('targetInfo');
      targetInfo.innerHTML = `
        <div class="data-row">
          <span class="data-label">SAT ID:</span>
          <span class="data-value">${t.name}</span>
        </div>
        <div class="data-row">
          <span class="data-label">ELEV:</span>
          <span class="data-value">${st.el.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">AZIM:</span>
          <span class="data-value">${st.az.toFixed(1)}°</span>
        </div>
        <div class="data-row">
          <span class="data-label">RANGE:</span>
          <span class="data-value">${(st.range/1000).toFixed(0)} km</span>
        </div>
        <div class="data-row">
          <span class="data-label">SNR:</span>
          <span class="data-value">${linkBudget.SNR.toFixed(1)} dB</span>
        </div>
      `;
      
      // Update satellite info panel
      updateSatelliteInfo(index, st, linkBudget);
      updateRFAnalysis(st, linkBudget);
      updateRFPlots();
      
      updateTerminalLog('SELECT', `Satellite selected: ${t.name} [${t.noradId}]`);
      
      // Refresh map to update colors
      setTimeout(() => updateSatellites(), 100);
    }
    
    function updateSatelliteInfo(index, st, linkBudget) {
      const satInfo = document.getElementById('sat-info');
      const t = tleList[index];
      
      if (!t || !st) {
        updateTerminalLog('SAT', 'Invalid satellite selection');
        return;
      }
      
      const noradId = t.line1 ? t.line1.substring(2, 7) : t.noradId;
      
      satInfo.innerHTML = `
        <div class="sat-info-item">
          <span class="sat-info-label">NORAD</span>
          <span class="sat-info-value">${noradId}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">NAME</span>
          <span class="sat-info-value">${(t.name || "SAT").substring(0, 12)}</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ALTITUDE</span>
          <span class="sat-info-value">${st.alt.toFixed(0)} km</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">VELOCITY</span>
          <span class="sat-info-value">${st.speed.toFixed(2)} km/s</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">ELEVATION</span>
          <span class="sat-info-value">${st.el.toFixed(1)}°</span>
        </div>
        <div class="sat-info-item">
          <span class="sat-info-label">AZIMUTH</span>
          <span class="sat-info-value">${st.az.toFixed(1)}°</span>
        </div>
      `;
    }
    
    function updateRFAnalysis(st, linkBudget) {
      document.getElementById('rf-snr').textContent = `${linkBudget.SNR.toFixed(1)} dB`;
      document.getElementById('rf-power').textContent = `${linkBudget.rxPower.toFixed(1)} dBm`;
      document.getElementById('rf-fspl').textContent = `${linkBudget.FSPL.toFixed(1)} dB`;
      document.getElementById('rf-rain').textContent = `${linkBudget.rainAttenuation.toFixed(1)} dB`;
      
      // Link status determination
      let status, statusClass;
      if (st.el < obs.elevMin) {
        status = 'BELOW HORIZON';
        statusClass = 'critical';
      } else if (linkBudget.SNR > 20) {
        status = 'EXCELLENT';
        statusClass = 'good';
      } else if (linkBudget.SNR > 15) {
        status = 'GOOD';
        statusClass = 'good';
      } else if (linkBudget.SNR > 10) {
        status = 'MARGINAL';
        statusClass = 'warning';
      } else {
        status = 'POOR';
        statusClass = 'critical';
      }
      
      const statusEl = document.getElementById('rf-status');
      statusEl.textContent = status;
      statusEl.className = `data-value ${statusClass}`;
    }
    
    function updateRFPlots() {
      if (typeof Plotly === 'undefined' || !selectedSatellite) return;
      
      const st = selectedSatellite.state;
      if (!st) return;
      
      // SNR vs Elevação
      const elevs = Array.from({length: 19}, (_, k) => k * 5);
      const snrs = elevs.map(e => {
        const rainAtt = config.considerRain && weatherData ? 
          calculateRainAttenuation(e, weatherData.precipitation) : 0;
        return calculateLinkBudget(e, rainAtt).SNR;
      });
      
      Plotly.newPlot("snrPlot", [{
        x: elevs,
        y: snrs,
        mode: "lines+markers",
        name: "SNR",
        line: { color: "#00ff00", width: 2 },
        marker: { color: "#00ff00", size: 4 }
      }], {
        title: {
          text: `SNR vs ELEVATION ${config.considerRain ? '[RAIN: ON]' : '[RAIN: OFF]'}`,
          font: { color: "#00ff00", family: "monospace", size: 11 }
        },
        xaxis: { 
          title: "ELEVATION (°)", 
          color: "#00ff00",
          gridcolor: "#003300",
          font: { family: "monospace", size: 10 }
        },
        yaxis: { 
          title: "SNR (dB)", 
          color: "#00ff00",
          gridcolor: "#003300",
          font: { family: "monospace", size: 10 }
        },
        margin: { t: 40, l: 50, r: 20, b: 40 },
        paper_bgcolor: "#000000",
        plot_bgcolor: "#000000",
        font: { color: "#00ff00", family: "monospace" }
      }, { displayModeBar: false });
      
      // Constelação QPSK
      const rainAtt = config.considerRain && weatherData ? 
        calculateRainAttenuation(st.el, weatherData.precipitation) : 0;
      const linkBudget = calculateLinkBudget(st.el, rainAtt);
      const noise = Math.max(0.01, 0.5 / Math.sqrt(Math.pow(10, linkBudget.SNR / 10)));
      const xs = [], ys = [], colors = [];
      
      // Gerar pontos QPSK com ruído
      for (let i = 0; i < 500; i++) {
        const symbolIndex = i % 4;
        const sym = [[1,1],[1,-1],[-1,1],[-1,-1]][symbolIndex];
        
        // Adicionar ruído gaussiano
        const noiseX = (Math.random() + Math.random() + Math.random() - 1.5) * noise * 0.67;
        const noiseY = (Math.random() + Math.random() + Math.random() - 1.5) * noise * 0.67;
        
        xs.push(sym[0] + noiseX);
        ys.push(sym[1] + noiseY);
        colors.push(['#00ff00', '#00ffff', '#ffff00', '#ff00ff'][symbolIndex]);
      }
      
      Plotly.newPlot("constPlot", [{
        x: xs,
        y: ys,
        mode: "markers",
        type: "scatter",
        marker: { 
          color: colors,
          size: 3,
          opacity: 0.7
        }
      }], {
        title: {
          text: `QPSK CONSTELLATION [SNR: ${linkBudget.SNR.toFixed(1)}dB]`,
          font: { color: "#00ff00", family: "monospace", size: 11 }
        },
        xaxis: { 
          range: [-2, 2],
          scaleanchor: "y",
          color: "#00ff00",
          gridcolor: "#003300",
          zeroline: true,
          zerolinecolor: "#00ff00",
          font: { family: "monospace", size: 10 }
        },
        yaxis: { 
          range: [-2, 2],
          color: "#00ff00",
          gridcolor: "#003300",
          zeroline: true,
          zerolinecolor: "#00ff00",
          font: { family: "monospace", size: 10 }
        },
        margin: { t: 40, l: 40, r: 40, b: 40 },
        paper_bgcolor: "#000000",
        plot_bgcolor: "#000000",
        font: { color: "#00ff00", family: "monospace" },
        showlegend: false
      }, { displayModeBar: false });
    }
    
    // ==================== UTILITÁRIOS ====================
    
    function updateTerminalLog(type, message) {
      const time = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
      
      const terminal = document.getElementById('terminalOutput');
      if (terminal) {
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.innerHTML = `<span class="time">[${time}]</span> <span class="type">[${type}]</span> <span class="message">${message}</span>`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
        
        while (terminal.children.length > 50) {
          terminal.removeChild(terminal.firstChild);
        }
      }
      
      console.log(`%c[${time}] [${type}] ${message}`, "color: #00ff00; font-family: monospace");
    }
    
    function updateStats(visible, tracked, total) {
      document.getElementById('stat-visible').textContent = visible || 0;
      document.getElementById('stat-tracked').textContent = tracked || 0;
      document.getElementById('stat-total').textContent = total || 0;
    }
    
    // ==================== INICIALIZAÇÃO ====================
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
